<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Expedientes Clínicos - Inicio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            --color-background-a: #03045e; /* Deep Twilight */
            --color-background-b: #0077b6; /* Bright Teal Blue */
            --color-background-falloff: #edf2f4; /* Softened base */
            --color-background-glow: rgba(237, 242, 244, 0.52);
            --color-card: #caf0f8;         /* Light Cyan */
            --color-card-border: #90e0ef;  /* Frosted Blue */
            --color-text: #03045e;         /* Deep Twilight */
            --color-muted: rgba(3, 4, 94, 0.72);
            --color-action: #0077b6;       /* Bright Teal Blue */
            --color-action-hover: #03045e; /* Deep Twilight */
            --shadow-strong: rgba(0, 180, 216, 0.32); /* Turquoise Surf */
            --color-input-bg: #90e0ef;     /* Frosted Blue */
            --color-input-border: #00b4d8; /* Turquoise Surf */
            --color-success: #00b4d8;      /* Turquoise Surf */
            --color-error: #b91c1c;        /* Complementary warm red */
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background-color: var(--color-background-falloff);
            background-image: radial-gradient(120% 140% at 50% -20%, var(--color-background-glow), rgba(237, 242, 244, 0.95) 62%, rgba(237, 242, 244, 0.98) 100%);
            color: var(--color-text);
            min-height: 100vh;
        }
        header { display: none; }
        main { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 32px 16px; }
        .card {
            background-color: var(--color-card);
            border-radius: 26px;
            box-shadow: 0 24px 60px var(--shadow-strong);
            padding: 42px 48px;
            width: min(420px, 100%);
            border: 1px solid var(--color-card-border);
            color: var(--color-text);
        }
        .card h2 {
            margin: 0 0 24px;
            font-size: 1.5rem;
            text-align: center;
            letter-spacing: 0.02em;
        }
        form { display: grid; gap: 20px; }
        .input-flow { display: grid; gap: 4px; }
        .input-group { position: relative; display: flex; flex-direction: column; gap: 6px; }
        .input-group input {
            border: 1px solid var(--color-input-border);
            border-radius: 14px;
            padding: 18px 16px 10px;
            font-size: 1rem;
            background-color: var(--color-input-bg);
            color: var(--color-text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--color-action);
            box-shadow: 0 0 0 4px rgba(0, 119, 182, 0.18);
            background-color: #ffffff;
        }
        .input-group label {
            position: absolute;
            top: 14px;
            left: 16px;
            color: var(--color-muted);
            font-size: 1rem;
            pointer-events: none;
            transition: transform 0.18s ease, font-size 0.18s ease, color 0.18s ease;
        }
        .input-group input:focus + label,
        .input-group input:not(:placeholder-shown) + label {
            transform: translateY(-12px);
            font-size: 0.75rem;
            color: var(--color-action);
        }
        .helper-text {
            font-size: 0.85rem;
            color: var(--color-muted);
            text-align: left;
            padding: 0 16px;
            margin: 4px 0 0;
            min-height: 24px;
            display: flex;
            align-items: center;
        }
        #login-status { margin-top: 12px; font-size: 0.95rem; min-height: 20px; text-align: center; color: var(--color-error); }
        #login-status.success { color: var(--color-success); }
        #email-feedback { font-size: 0.85rem; color: var(--color-error); }
        #email-feedback.success { color: var(--color-success); }
        .collapsible {
            max-height: 0;
            opacity: 0;
            transform: translateY(-4px);
            pointer-events: none;
            visibility: hidden;
            overflow: hidden;
            margin-top: 0;
            transition: max-height 0.25s ease, opacity 0.2s ease, transform 0.2s ease, margin-top 0.2s ease;
        }
        .collapsible[data-visible="true"] {
            max-height: 160px;
            opacity: 1;
            transform: translateY(-2px);
            pointer-events: auto;
            visibility: visible;
            margin-top: -4px;
        }
        #code-container { display: grid; gap: 0; }
        #code-feedback { font-size: 0.85rem; color: var(--color-error); }
        #code-feedback.success { color: var(--color-success); }
        #email-feedback:empty,
        #code-feedback:empty {
            visibility: hidden;
        }
        .button-row { margin-top: 16px; display: flex; justify-content: center; gap: 12px; }
        .form-button {
            border: none;
            border-radius: 999px;
            padding: 12px 22px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background-color: var(--color-action);
            color: #fff;
            box-shadow: 0 10px 26px rgba(0, 119, 182, 0.28);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .form-button:hover {
            background-color: var(--color-action-hover);
            box-shadow: 0 12px 32px rgba(3, 4, 94, 0.32);
        }
        .form-button:active { transform: scale(0.98); }
        .form-button[disabled] {
            opacity: 0.65;
            cursor: default;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Expedientes Clínicos</h1>
    </header>
    <main>
        <section class="card" aria-live="polite">
            <form id="login-form" autocomplete="off">
                <h2>Ingresar</h2>
                <div class="input-flow">
                    <div class="input-group">
                        <input id="login-email" name="email" type="email" placeholder=" " required autocomplete="email">
                        <label for="login-email">Correo electrónico</label>
                    </div>
                    <p id="email-feedback" class="helper-text"></p>
                    <div id="code-container" class="collapsible" data-visible="false" aria-hidden="true">
                        <div id="code-group" class="input-group">
                            <input id="login-code" name="code" type="text" placeholder=" " inputmode="numeric" autocomplete="one-time-code">
                            <label for="login-code">Código</label>
                        </div>
                        <p id="code-feedback" class="helper-text"></p>
                    </div>
                </div>
                <div class="button-row">
                    <button id="send-code-button" type="button" class="form-button">Enviar código</button>
                    <button id="verify-code-button" type="button" class="form-button" hidden aria-hidden="true">Confirmar código</button>
                </div>
            </form>
            <p id="login-status"></p>
        </section>
    </main>

    <script>
        (function () {
            const STORAGE_KEY = 'expedientesclinicos.apiBaseUrl';
            const DEFAULT_URL = "https://expedientesclinicos.onrender.com";
            const USER_ID_KEY = 'expedientesclinicos.usuarioId';
            const ROLE_KEY = 'expedientesclinicos.role';
            const LEGACY_THERAPIST_KEY = 'expedientesclinicos.therapistId';

            if (!sessionStorage.getItem(STORAGE_KEY)) {
                sessionStorage.setItem(STORAGE_KEY, DEFAULT_URL);
            }

            const loginForm = document.getElementById('login-form');
            const loginStatus = document.getElementById('login-status');
            const emailInput = document.getElementById('login-email');
            const codeInput = document.getElementById('login-code');
            const codeContainer = document.getElementById('code-container');
            const emailFeedback = document.getElementById('email-feedback');
            const codeFeedback = document.getElementById('code-feedback');
            const sendButton = document.getElementById('send-code-button');
            const verifyButton = document.getElementById('verify-code-button');
            let awaitingCode = false;

            codeInput.disabled = true;
            const clearFeedback = function () {
                loginStatus.textContent = '';
                loginStatus.classList.remove('success');
                emailFeedback.textContent = '';
                emailFeedback.classList.remove('success');
                codeFeedback.textContent = '';
                codeFeedback.classList.remove('success');
            };

            const updateActionButtons = function () {
                if (awaitingCode) {
                    sendButton.hidden = true;
                    sendButton.setAttribute('aria-hidden', 'true');
                    sendButton.disabled = false;
                    verifyButton.hidden = false;
                    verifyButton.removeAttribute('aria-hidden');
                } else {
                    verifyButton.hidden = true;
                    verifyButton.setAttribute('aria-hidden', 'true');
                    verifyButton.disabled = false;
                    sendButton.hidden = false;
                    sendButton.removeAttribute('aria-hidden');
                }
            };
            updateActionButtons();

            let storedId = sessionStorage.getItem(USER_ID_KEY);
            let storedRole = sessionStorage.getItem(ROLE_KEY);
            if (!storedId) {
                const legacyId = sessionStorage.getItem(LEGACY_THERAPIST_KEY);
                if (legacyId) {
                    storedId = legacyId;
                    sessionStorage.setItem(USER_ID_KEY, legacyId);
                    if (!storedRole) {
                        storedRole = 'TERAPEUTA';
                        sessionStorage.setItem(ROLE_KEY, storedRole);
                    }
                }
            }
            if (storedId && storedRole) {
                const destination = storedRole === 'ADMINISTRADOR' ? 'panel_admin.html' : 'pacientes.html';
                window.location.href = destination;
                return;
            }

            const resetCodeStep = function () {
                awaitingCode = false;
                codeContainer.dataset.visible = 'false';
                codeContainer.setAttribute('aria-hidden', 'true');
                codeInput.disabled = true;
                codeInput.value = '';
                codeFeedback.textContent = '';
                codeFeedback.classList.remove('success');
                updateActionButtons();
            };

            emailInput.addEventListener('input', function () {
                clearFeedback();
                resetCodeStep();
            });
            const requestCode = async function () {
                const correo = (emailInput.value || '').trim();
                clearFeedback();
                if (!correo) {
                    emailFeedback.textContent = 'Ingresa un correo válido.';
                    return;
                }
                const apiBase = sessionStorage.getItem(STORAGE_KEY) || DEFAULT_URL;
                sendButton.disabled = true;
                try {
                    const resp = await fetch(apiBase + '/api/auth/request-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ correo })
                    });
                    if (!resp.ok) {
                        if (resp.status === 404) {
                            emailFeedback.textContent = 'Correo no registrado.';
                            resetCodeStep();
                        } else {
                            loginStatus.textContent = 'No fue posible enviar el código.';
                        }
                        return;
                    }
                    awaitingCode = true;
                    codeContainer.dataset.visible = 'true';
                    codeContainer.setAttribute('aria-hidden', 'false');
                    codeInput.disabled = false;
                    emailFeedback.textContent = '';
                    codeFeedback.textContent = 'Código enviado. Revisa tu correo.';
                    codeFeedback.classList.add('success');
                    updateActionButtons();
                    codeInput.focus({ preventScroll: true });
                } catch (e) {
                    loginStatus.textContent = 'Error de red solicitando el código.';
                } finally {
                    sendButton.disabled = false;
                }
            };

            const verifyCode = async function () {
                const correo = (emailInput.value || '').trim();
                const codigo = (codeInput.value || '').trim();
                clearFeedback();
                if (!correo || !codigo) {
                    codeFeedback.textContent = 'Escribe tu correo y el código recibido.';
                    return;
                }
                const apiBase = sessionStorage.getItem(STORAGE_KEY) || DEFAULT_URL;
                verifyButton.disabled = true;
                try {
                    const resp = await fetch(apiBase + '/api/auth/verify-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ correo, codigo })
                    });
                    if (!resp.ok) {
                        if (resp.status === 404) {
                            codeFeedback.textContent = 'Código inválido.';
                        } else {
                            loginStatus.textContent = 'No fue posible verificar el código.';
                        }
                        return;
                    }
                    const data = await resp.json();
                    const role = data.rol || 'TERAPEUTA';
                    const userId = String(data.usuarioId);
                    sessionStorage.setItem(USER_ID_KEY, userId);
                    sessionStorage.setItem(ROLE_KEY, role);
                    sessionStorage.removeItem(LEGACY_THERAPIST_KEY);
                    if (role === 'TERAPEUTA') {
                        sessionStorage.setItem(LEGACY_THERAPIST_KEY, userId);
                    }
                    window.location.href = role === 'ADMINISTRADOR' ? 'panel_admin.html' : 'pacientes.html';
                } catch (e) {
                    loginStatus.textContent = 'Error de red verificando el código.';
                } finally {
                    if (awaitingCode) {
                        verifyButton.disabled = false;
                    }
                }
            };

            sendButton.addEventListener('click', requestCode);
            verifyButton.addEventListener('click', verifyCode);
            loginForm.addEventListener('submit', function (event) {
                event.preventDefault();
                if (awaitingCode) {
                    verifyCode();
                } else {
                    requestCode();
                }
            });
        }());
    </script>
</body>
</html>
