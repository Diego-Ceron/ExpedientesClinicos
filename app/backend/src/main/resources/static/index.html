<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Expedientes Clínicos - Inicio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            --color-navy: #555879;
            --color-navy-light: #98A1BC;
            --color-beige: #DED3C4;
            --color-cream: #F4EBD3;
            --color-text: #2f2f3a;
            --shadow-strong: rgba(85, 88, 121, 0.16);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background-color: var(--color-cream); color: var(--color-text); }
        header { background-color: var(--color-navy); color: #fff; padding: 16px 24px; }
        header h1 { margin: 0; font-size: 1.6rem; }
        main { display: flex; align-items: center; justify-content: center; padding: 48px 16px 64px; }
        .card { background-color: #fff; border-radius: 16px; box-shadow: 0 12px 28px var(--shadow-strong); padding: 32px 36px; width: min(420px, 100%); border: 1px solid rgba(152, 161, 188, 0.25); }
        .card h2 { margin: 0 0 16px; font-size: 1.4rem; text-align: center; }
        form { display: grid; gap: 16px; }
        label { font-size: 0.95rem; font-weight: 600; color: var(--color-text); display: grid; gap: 8px; }
        input[type="text"] { border: 1px solid rgba(152, 161, 188, 0.6); border-radius: 10px; padding: 12px; font-size: 1rem; background-color: #fff; color: var(--color-text); }
        input[type="text"]:focus { outline: 2px solid var(--color-navy); }
        button { border: none; border-radius: 10px; padding: 12px; font-weight: 600; font-size: 1rem; background-color: var(--color-navy); color: #fff; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; }
        button:hover { background-color: #404561; }
        button:active { transform: scale(0.98); }
        .account-toggle { display: inline-flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--color-navy-light); }
        .account-toggle input { accent-color: var(--color-navy); }
        #login-status { margin-top: 12px; font-size: 0.95rem; min-height: 20px; text-align: center; color: #c62828; }
        #login-status.success { color: var(--color-navy); }
    </style>
</head>
<body>
    <header>
        <h1>Expedientes Clínicos</h1>
    </header>
    <main>
        <section class="card" aria-live="polite">
            <form id="login-form" autocomplete="off">
                <h2>Iniciar sesión</h2>
                <label for="login-email">Correo electrónico</label>
                <input id="login-email" name="email" type="text" required placeholder="correo@ejemplo.com">
                <div class="account-toggle" style="margin-top:-6px">Se enviará un código de verificación a tu correo</div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="request-code-btn" type="button">Enviar código</button>
                    <span id="request-hint" style="font-size:0.85rem; color:#98A1BC;"></span>
                </div>
                <div id="code-step" style="display:none; margin-top:10px;">
                    <label for="login-code">Código de verificación</label>
                    <input id="login-code" name="code" type="text" placeholder="123456" inputmode="numeric">
                    <button id="verify-code-btn" type="button">Verificar y entrar</button>
                </div>
            </form>
            <p id="login-status"></p>
        </section>
    </main>

    <script>
        (function () {
            const STORAGE_KEY = 'expedientesclinicos.apiBaseUrl';
            const DEFAULT_URL = "https://expedientesclinicos.onrender.com";
            const USER_ID_KEY = 'expedientesclinicos.usuarioId';
            const ROLE_KEY = 'expedientesclinicos.role';
            const LEGACY_THERAPIST_KEY = 'expedientesclinicos.therapistId';

            if (!sessionStorage.getItem(STORAGE_KEY)) {
                sessionStorage.setItem(STORAGE_KEY, DEFAULT_URL);
            }

            const loginForm = document.getElementById('login-form');
            const loginStatus = document.getElementById('login-status');
            const emailInput = document.getElementById('login-email');
            const codeInput = document.getElementById('login-code');
            const requestBtn = document.getElementById('request-code-btn');
            const verifyBtn = document.getElementById('verify-code-btn');
            const codeStep = document.getElementById('code-step');
            const requestHint = document.getElementById('request-hint');

            let storedId = sessionStorage.getItem(USER_ID_KEY);
            let storedRole = sessionStorage.getItem(ROLE_KEY);
            if (!storedId) {
                const legacyId = sessionStorage.getItem(LEGACY_THERAPIST_KEY);
                if (legacyId) {
                    storedId = legacyId;
                    sessionStorage.setItem(USER_ID_KEY, legacyId);
                    if (!storedRole) {
                        storedRole = 'TERAPEUTA';
                        sessionStorage.setItem(ROLE_KEY, storedRole);
                    }
                }
            }
            if (storedId && storedRole) {
                const destination = storedRole === 'ADMINISTRADOR' ? 'panel_admin.html' : 'pacientes.html';
                window.location.href = destination;
                return;
            }

            requestBtn.addEventListener('click', async function() {
                const correo = (emailInput.value || '').trim();
                loginStatus.textContent = '';
                loginStatus.classList.remove('success');
                if (!correo) {
                    loginStatus.textContent = 'Ingresa un correo válido.';
                    return;
                }
                const apiBase = sessionStorage.getItem(STORAGE_KEY) || DEFAULT_URL;
                try {
                    const resp = await fetch(apiBase + '/api/auth/request-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ correo })
                    });
                    if (!resp.ok) {
                        if (resp.status === 404) {
                            loginStatus.textContent = 'Correo no registrado.';
                        } else {
                            loginStatus.textContent = 'No fue posible enviar el código.';
                        }
                        return;
                    }
                    codeStep.style.display = 'block';
                    requestHint.textContent = 'Código enviado. Revisa tu correo.';
                    loginStatus.textContent = '';
                    loginStatus.classList.add('success');
                } catch (e) {
                    loginStatus.textContent = 'Error de red solicitando el código.';
                }
            });

            verifyBtn.addEventListener('click', async function() {
                const correo = (emailInput.value || '').trim();
                const codigo = (codeInput.value || '').trim();
                loginStatus.textContent = '';
                loginStatus.classList.remove('success');
                if (!correo || !codigo) {
                    loginStatus.textContent = 'Escribe tu correo y el código recibido.';
                    return;
                }
                const apiBase = sessionStorage.getItem(STORAGE_KEY) || DEFAULT_URL;
                try {
                    const resp = await fetch(apiBase + '/api/auth/verify-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ correo, codigo })
                    });
                    if (!resp.ok) {
                        loginStatus.textContent = resp.status === 404 ? 'Código inválido o expirado.' : 'No fue posible verificar el código.';
                        return;
                    }
                    const data = await resp.json();
                    const role = data.rol || 'TERAPEUTA';
                    const userId = String(data.usuarioId);
                    sessionStorage.setItem(USER_ID_KEY, userId);
                    sessionStorage.setItem(ROLE_KEY, role);
                    sessionStorage.removeItem(LEGACY_THERAPIST_KEY);
                    if (role === 'TERAPEUTA') {
                        sessionStorage.setItem(LEGACY_THERAPIST_KEY, userId);
                    }
                    window.location.href = role === 'ADMINISTRADOR' ? 'panel_admin.html' : 'pacientes.html';
                } catch (e) {
                    loginStatus.textContent = 'Error de red verificando el código.';
                }
            });
        }());
    </script>
</body>
</html>
