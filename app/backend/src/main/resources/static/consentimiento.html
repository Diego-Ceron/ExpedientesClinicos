<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consentimiento informado - Expedientes Clínicos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            --color-navy: #555879;
            --color-navy-light: #98A1BC;
            --color-beige: #DED3C4;
            --color-cream: #F4EBD3;
            --color-text: #2f2f3a;
            --shadow-strong: rgba(85, 88, 121, 0.18);
            --shadow-soft: rgba(85, 88, 121, 0.12);
        }
        * { box-sizing: border-box; }
        body { margin:0; font-family: "Segoe UI", Arial, sans-serif; background-color: var(--color-cream); color: var(--color-text); }
        header { background-color: var(--color-navy); color:#fff; padding:16px 24px; }
        header h1 { margin:0; font-size:1.5rem; }
        main { max-width:1024px; margin:32px auto; padding:0 16px 48px; }
        .card { background-color:#fff; border-radius:16px; box-shadow:0 12px 28px var(--shadow-strong); overflow:hidden; border:1px solid rgba(152,161,188,0.25); }
        .card-header { padding:24px 28px 16px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:flex-start; gap:16px; }
        .card-header h2 { margin:0; font-size:1.6rem; }
        .card-header p { margin:4px 0 0; color: var(--color-navy-light); }
        .card-actions { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        .status-chip { display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px; background-color: rgba(152,161,188,0.22); color: var(--color-navy); font-weight:600; font-size:0.9rem; }
        .status-chip.estado-activo { background-color:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
        .status-chip.estado-en-espera { background-color: rgba(152,161,188,0.22); color: var(--color-navy); border:1px solid rgba(152,161,188,0.3); }
        .status-chip.estado-archivado { background-color:#fef3c7; color:#92400e; border:1px solid #fde68a; }
        .status-banner { margin:0 28px 16px; padding:10px 14px; border-radius:8px; background-color: rgba(152,161,188,0.15); color: var(--color-navy); font-weight:600; min-height:24px; }
        .status-banner.error { background-color:#fdecea; color:#b3261e; }
        .panel { background-color:#fff; border:1px solid rgba(152,161,188,0.25); border-radius:12px; padding:20px 24px; box-shadow:0 4px 14px var(--shadow-soft); margin:0 28px 28px; }
        button { border:none; border-radius:8px; padding:10px 18px; cursor:pointer; font-weight:600; font-size:0.95rem; background-color: var(--color-navy); color:#fff; transition: background-color .2s ease, transform .2s ease; }
        button:hover { background-color:#404561; }
        button:active { transform: scale(.98); }
        button.button-secondary { background-color: var(--color-beige); color: var(--color-navy); }
        button.button-secondary:hover { background-color:#cfc2b1; }
        button.button-outline { background-color: transparent; color: var(--color-navy); border:1px solid var(--color-navy); }
        button.button-outline:hover { background-color: rgba(152,161,188,0.2); }
        #back-button { background-color: var(--color-beige); color: var(--color-navy); }
        #back-button:hover { background-color:#cfc2b1; }
        .button-muted { background-color: #e5e7eb !important; color: #9aa0b4 !important; border-color: #d1d5db !important; }
        .button-muted:hover { background-color: #e5e7eb !important; }
        label.form-field { display:flex; flex-direction:column; gap:6px; font-weight:600; color:var(--color-text); font-size:0.95rem; }
        input[type="text"], textarea { width:100%; border:1px solid rgba(152,161,188,0.6); border-radius:8px; padding:10px 12px; font-family:inherit; font-size:0.95rem; color:var(--color-text); background-color:#fff; }
        textarea { min-height:140px; resize:vertical; }
        @media (max-width: 600px) {
            .card-header { flex-direction: column; align-items:flex-start; }
            .card-actions { width:100%; justify-content:flex-start; }
        }
    </style>
</head>
<body>
<header>
    <h1>Expedientes Clínicos</h1>
</header>
<main>
    <section class="card" aria-live="polite">
        <div class="card-header">
            <div>
                <h2 id="page-title">Consentimiento informado</h2>
                <p id="patient-info" class="card-subtitle"></p>
            </div>
            <div class="card-actions">
                <span id="patient-status" class="status-chip" hidden>Estado</span>
                <button id="back-button" type="button" class="button-secondary">Volver a pacientes</button>
                <button id="back-expediente-button" type="button" class="button-outline">Volver al expediente</button>
            </div>
        </div>
        <p id="context-info" hidden></p>
        <div id="status-banner" class="status-banner"></div>
        <section class="panel" aria-labelledby="form-title">
            <h3 id="form-title">Registro de consentimiento</h3>
            <form id="consent-form">
                <label class="form-field" for="alcance">Alcance del consentimiento
                    <textarea id="alcance" name="alcance" required></textarea>
                </label>
                <label class="form-field" for="riesgos">Riesgos y beneficios
                    <textarea id="riesgos" name="riesgos"></textarea>
                </label>
                <label class="form-field" for="aceptacion">Aceptación del paciente
                    <input id="aceptacion" name="aceptacion" type="text" placeholder="Acepto / No acepto" required>
                </label>
                <div class="card-actions">
                    <button id="edit-button" type="button" class="button-outline">Editar</button>
                    <button id="print-button" type="button" class="button-secondary" style="margin-left:auto">Imprimir</button>
                    <button id="save-button" type="submit" hidden>Guardar</button>
                </div>
            </form>
        </section>
    </section>
</main>
<script>
(function(){
    const DEFAULT_API_URL = "https://expedientesclinicos.onrender.com";
    const API_BASE_KEY = 'expedientesclinicos.apiBaseUrl';
    const ROLE_KEY = 'expedientesclinicos.role';
    const USER_ID_KEY = 'expedientesclinicos.usuarioId';
    const LEGACY_THERAPIST_KEY = 'expedientesclinicos.therapistId';

    let viewerId = null;
    let perfil = 'TERAPEUTA';
    let isAdmin = false;

    const STATUS_MAP = {
        ACTIVO: { text: 'Activo', className: 'estado-activo' },
        EN_ESPERA: { text: 'En espera', className: 'estado-en-espera' },
        ARCHIVADO: { text: 'Archivado', className: 'estado-archivado' }
    };

    let currentPatient = null;

    const isPatientArchived = function () {
        return Boolean(currentPatient && currentPatient.estado === 'ARCHIVADO');
    };

    const backButton = document.getElementById('back-button');
    const backExpedienteButton = document.getElementById('back-expediente-button');
    const patientInfo = document.getElementById('patient-info');
    const patientStatus = document.getElementById('patient-status');
    const statusBanner = document.getElementById('status-banner');
    const contextInfo = document.getElementById('context-info');
    const form = document.getElementById('consent-form');
    const editButton = document.getElementById('edit-button');
    const printButton = document.getElementById('print-button');
        printButton.addEventListener('click', async function(){
            if (Number.isNaN(pacienteId)) {
                statusBanner.textContent = 'Paciente no válido para imprimir.';
                statusBanner.classList.add('error');
                return;
            }
            statusBanner.textContent = 'Generando PDF...';
            statusBanner.classList.remove('error');
            try {
                const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId) + '/consentimiento/pdf');
                url.searchParams.set('usuarioId', therapistId);
                url.searchParams.set('perfil', perfil);
                const resp = await fetch(url.toString());
                if(!resp.ok){ throw new Error('Error ' + resp.status + ' al generar PDF'); }
                const blob = await resp.blob();
                const pdfUrl = URL.createObjectURL(blob);
                window.open(pdfUrl, '_blank');
                setTimeout(function(){ URL.revokeObjectURL(pdfUrl); }, 120000);
                statusBanner.textContent = 'PDF abierto en nueva pestaña.';
            } catch(err){
                statusBanner.textContent = err.message || 'No se pudo generar el PDF.';
                statusBanner.classList.add('error');
            }
        });
    const saveButton = document.getElementById('save-button');
    const CONSENT_FIELD_IDS = ['alcance', 'riesgos', 'aceptacion'];

    const setFieldsReadOnly = function (readOnly) {
        CONSENT_FIELD_IDS.forEach(function (id) {
            const element = document.getElementById(id);
            if (element) {
                element.readOnly = readOnly;
            }
        });
    };

    let editMode = false;

    const refreshEditButtonVisibility = function () {
        if (!editButton || isAdmin) {
            if (editButton) {
                editButton.hidden = true;
            }
            if (saveButton) {
                saveButton.hidden = true;
            }
            return;
        }
        if (isPatientArchived()) {
            editButton.hidden = true;
            if (saveButton) {
                saveButton.hidden = true;
            }
        } else {
            editButton.hidden = false;
            if (saveButton) {
                saveButton.hidden = !editMode;
            }
        }
    };

    function setEditMode(enabled){
        editMode = enabled;
        if (saveButton) {
            saveButton.hidden = !enabled;
        }
        if (editButton) {
            editButton.textContent = enabled ? 'Cancelar' : 'Editar';
        }
        setFieldsReadOnly(!enabled);
        refreshEditButtonVisibility();
    }

    if (editButton) {
        editButton.addEventListener('click', function(){
            if (isAdmin) {
                statusBanner.textContent = 'Solo el terapeuta puede editar el consentimiento.';
                statusBanner.classList.add('error');
                return;
            }
            if (isPatientArchived()) {
                statusBanner.textContent = 'El paciente se encuentra archivado; no es posible editar el consentimiento.';
                statusBanner.classList.remove('error');
                return;
            }
            setEditMode(!editMode);
        });
    }

    setEditMode(false);

    const params = new URLSearchParams(window.location.search);
    const pacienteIdParam = params.get('pacienteId');
    const pacienteId = pacienteIdParam ? Number(pacienteIdParam) : NaN;
    const terapeutaOrigenParam = params.get('terapeutaId');
    const terapeutaOrigenId = terapeutaOrigenParam ? Number(terapeutaOrigenParam) : NaN;

    const role = sessionStorage.getItem(ROLE_KEY);
    const isTherapist = role === 'TERAPEUTA';
    isAdmin = role === 'ADMINISTRADOR';
    if (!isTherapist && !isAdmin) {
        window.location.href = 'index.html';
        return;
    }

    let therapistIdRaw = sessionStorage.getItem(USER_ID_KEY);
    if (!therapistIdRaw && isTherapist) {
        const legacyId = sessionStorage.getItem(LEGACY_THERAPIST_KEY);
        if (legacyId) {
            therapistIdRaw = legacyId;
            sessionStorage.setItem(USER_ID_KEY, legacyId);
        }
    }
    if (!therapistIdRaw) {
        window.location.href = 'index.html';
        return;
    }
    viewerId = Number(therapistIdRaw);
    if (Number.isNaN(viewerId)) {
        statusBanner.textContent = 'La sesión actual no cuenta con un identificador válido.';
        statusBanner.classList.add('error');
        return;
    }
    perfil = isAdmin ? 'ADMINISTRADOR' : 'TERAPEUTA';
    const therapistId = viewerId;

    const updatePatientContext = function (patient) {
        currentPatient = patient || null;
        if (patientInfo) {
            if (patient && patient.nombreCompleto) {
                const servicio = patient.tipoServicio ? ' · ' + patient.tipoServicio.replace(/_/g, ' ').toLowerCase() : '';
                patientInfo.textContent = patient.nombreCompleto + servicio;
            } else {
                patientInfo.textContent = 'Paciente ID: ' + pacienteId;
            }
        }
        if (patientStatus) {
            if (patient && patient.estado) {
                const statusData = STATUS_MAP[patient.estado] || { text: patient.estado, className: '' };
                patientStatus.textContent = statusData.text;
                patientStatus.className = 'status-chip' + (statusData.className ? ' ' + statusData.className : '');
                patientStatus.hidden = false;
            } else {
                patientStatus.hidden = true;
            }
        }
        refreshEditButtonVisibility();
    };

    const fetchPatient = async function () {
        if (Number.isNaN(pacienteId)) {
            return null;
        }
        const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId));
        url.searchParams.set('usuarioId', therapistId);
        url.searchParams.set('perfil', perfil);
        const response = await fetch(url.toString());
        if (!response.ok) {
            throw new Error('Error ' + response.status + ' al obtener la información del paciente.');
        }
        const patient = await response.json();
        updatePatientContext(patient);
        return patient;
    };

    if (Number.isNaN(pacienteId)) {
        statusBanner.textContent = 'Selecciona un paciente desde la lista para registrar consentimiento.';
        statusBanner.classList.add('error');
    } else {
        patientInfo.textContent = 'Paciente ID: ' + pacienteId;
    }

    const apiBaseUrl = sessionStorage.getItem(API_BASE_KEY) || DEFAULT_API_URL;
    if (contextInfo) {
        contextInfo.textContent = isAdmin ? 'Vista de administrador sin permisos de edición.' : '';
        contextInfo.hidden = !isAdmin;
    }

    if (isAdmin) {
        setFieldsReadOnly(true);
        refreshEditButtonVisibility();
    }

    backButton.addEventListener('click', function(){
        if (isAdmin) {
            if (!Number.isNaN(terapeutaOrigenId)) {
                window.location.href = 'terapeuta.html?terapeutaId=' + encodeURIComponent(terapeutaOrigenId);
                return;
            }
            window.location.href = 'panel_admin.html';
            return;
        }
        window.location.href = 'pacientes.html';
    });

    const buildExpedienteUrl = function () {
        if (Number.isNaN(pacienteId)) {
            return null;
        }
        let target = 'expediente.html?pacienteId=' + encodeURIComponent(pacienteId);
        if (isAdmin && !Number.isNaN(terapeutaOrigenId)) {
            target += '&terapeutaId=' + encodeURIComponent(terapeutaOrigenId);
        }
        return target;
    };

    backExpedienteButton.addEventListener('click', function(){
        const target = buildExpedienteUrl();
        if (target) {
            window.location.href = target;
        }
    });

    async function cargarConsentimiento(){
        if (Number.isNaN(pacienteId)) {
            return 'invalid';
        }
        const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId) + '/consentimiento');
        url.searchParams.set('usuarioId', therapistId);
        url.searchParams.set('perfil', perfil);
        const response = await fetch(url.toString());
        if (response.status === 404) {
            document.getElementById('alcance').value = '';
            document.getElementById('riesgos').value = '';
            document.getElementById('aceptacion').value = '';
            return 'empty';
        }
        if (!response.ok) {
            throw new Error('Error ' + response.status + ' al obtener el consentimiento.');
        }
        const data = await response.json();
        document.getElementById('alcance').value = data.alcance || '';
        document.getElementById('riesgos').value = data.riesgos || '';
        document.getElementById('aceptacion').value = data.aceptacion || '';
        return 'loaded';
    }

    form.addEventListener('submit', async function(e){
        e.preventDefault();
        if (isAdmin) {
            statusBanner.textContent = 'Solo el terapeuta puede guardar el consentimiento.';
            statusBanner.classList.add('error');
            return;
        }
        if (!editMode) {
            statusBanner.textContent = 'Activa edición para guardar cambios.';
            statusBanner.classList.add('error');
            return;
        }
        if (isPatientArchived()) {
            statusBanner.textContent = 'El paciente está archivado; reactívalo para actualizar el consentimiento.';
            statusBanner.classList.remove('error');
            return;
        }
        if (Number.isNaN(pacienteId)) {
            statusBanner.textContent = 'No se puede guardar: paciente no válido.';
            statusBanner.classList.add('error');
            return;
        }
        statusBanner.textContent = 'Guardando consentimiento...';
        statusBanner.classList.remove('error');
        const payload = {
            solicitante: { usuarioId: therapistId, perfil: perfil },
            alcance: document.getElementById('alcance').value.trim(),
            riesgos: document.getElementById('riesgos').value.trim() || null,
            aceptacion: document.getElementById('aceptacion').value.trim()
        };
        const url = apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId) + '/consentimiento';
        try {
            const method = 'PUT';
            const resp = await fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if(!resp.ok){ throw new Error('Error ' + resp.status + ' al guardar consentimiento'); }
            statusBanner.textContent = 'Consentimiento guardado.';
            statusBanner.classList.remove('error');
            setEditMode(false);
        } catch(err){
            statusBanner.textContent = err.message || 'No fue posible guardar el consentimiento.';
            statusBanner.classList.add('error');
        }
    });

    const loadPage = async function () {
        if (Number.isNaN(pacienteId)) {
            refreshEditButtonVisibility();
            return;
        }
        statusBanner.textContent = 'Cargando consentimiento...';
        statusBanner.classList.remove('error');
        try {
            await fetchPatient();
            const result = await cargarConsentimiento();
            setEditMode(false);
            refreshEditButtonVisibility();
            if (result === 'empty') {
                statusBanner.textContent = 'Aún no hay consentimiento registrado.';
            } else {
                statusBanner.textContent = 'Consentimiento cargado.';
            }
        } catch (error) {
            statusBanner.textContent = error.message || 'No fue posible cargar el consentimiento.';
            statusBanner.classList.add('error');
            refreshEditButtonVisibility();
        }
    };

    loadPage();
})();
</script>
</body>
</html>
