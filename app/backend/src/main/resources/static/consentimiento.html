<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consentimiento informado - Expedientes Clínicos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            --color-navy: #03045e;
            --color-navy-light: rgba(3, 4, 94, 0.72);
            --color-beige: #90e0ef;
            --color-cream: #caf0f8;
            --color-accent: #0077b6;
            --color-accent-soft: rgba(0, 180, 216, 0.16);
            --color-border: #00b4d8;
            --color-text: #03045e;
            --shadow-strong: rgba(0, 180, 216, 0.24);
            --shadow-soft: rgba(0, 180, 216, 0.16);
            --color-danger: #b91c1c;
            --color-background-falloff: #edf2f4;
            --color-background-glow: rgba(237, 242, 244, 0.52);
            --state-active-bg: #dcfce7;
            --state-active-text: #166534;
            --state-active-border: #bbf7d0;
            --state-pending-bg: #e0f2fe;
            --state-pending-text: #0369a1;
            --state-pending-border: #bae6fd;
            --state-archived-bg: #fef3c7;
            --state-archived-text: #92400e;
            --state-archived-border: #fde68a;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background-color: var(--color-background-falloff);
            background-image: radial-gradient(120% 140% at 50% -20%, var(--color-background-glow), rgba(237, 242, 244, 0.95) 62%, rgba(237, 242, 244, 0.98) 100%);
            color: var(--color-text);
        }
        header { background-color: var(--color-navy); color: #fff; padding: 16px 24px; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18); }
        header h1 { margin: 0; font-size: 1.5rem; }
        main { max-width: 1024px; margin: 32px auto; padding: 0 16px 48px; }
        .card { background-color: var(--color-cream); border-radius: 20px; box-shadow: 0 20px 44px var(--shadow-strong); overflow: hidden; border: 1px solid var(--color-border); backdrop-filter: blur(6px); display: flex; flex-direction: column; }
        .card-header { padding: 24px 28px 16px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 16px; background: none; border-bottom: 1px solid rgba(0, 180, 216, 0.22); }
        .card-header h2 { margin: 0; font-size: 1.6rem; }
        .card-header p { margin: 4px 0 0; color: var(--color-navy-light); }
        .card-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .status-chip { display: inline-flex; align-items: center; padding: 6px 14px; border-radius: 999px; font-weight: 600; font-size: 0.9rem; border: 1px solid var(--state-active-border); background-color: var(--state-active-bg); color: var(--state-active-text); }
        .status-chip.estado-activo { background-color: var(--state-active-bg); color: var(--state-active-text); border-color: var(--state-active-border); }
        .status-chip.estado-en-espera { background-color: var(--state-pending-bg); color: var(--state-pending-text); border-color: var(--state-pending-border); }
        .status-chip.estado-archivado { background-color: var(--state-archived-bg); color: var(--state-archived-text); border-color: var(--state-archived-border); }
        .status-banner { margin: 0; margin-bottom: 16px; padding: 12px 16px; border-radius: 12px; background-color: var(--color-accent-soft); color: var(--color-accent); font-weight: 600; min-height: 24px; }
        .status-banner:empty { display: none; }
        .status-banner.error { background-color: rgba(185, 28, 28, 0.12); color: var(--color-danger); }
        .card-body { padding: 0 28px 28px; display: grid; gap: 20px; }
        #context-info { margin: 0; color: var(--color-navy-light); font-size: 0.95rem; }
        .panel { background-color: rgba(255, 255, 255, 0.9); border: 1px solid var(--color-border); border-radius: 16px; padding: 22px 26px; box-shadow: 0 12px 30px var(--shadow-soft); backdrop-filter: blur(4px); display: grid; gap: 18px; }
        .panel h3 { margin: 0; font-size: 1.25rem; color: var(--color-text); }
        form { display: grid; gap: 16px; }
        label.form-field { display: grid; gap: 8px; font-weight: 600; color: var(--color-text); font-size: 0.95rem; }
        textarea, input[type="text"] { width: 100%; border: 1px solid var(--color-border); border-radius: 12px; padding: 12px 14px; font-family: inherit; font-size: 0.95rem; color: var(--color-text); background-color: var(--color-cream); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4); transition: background-color 0.2s ease, border-color 0.2s ease; }
        textarea:focus, input[type="text"]:focus { outline: 2px solid var(--color-accent); outline-offset: 1px; background-color: #fff; }
        textarea[readonly], input[type="text"][readonly] { background-color: rgba(202, 240, 248, 0.6); border-color: rgba(0, 180, 216, 0.32); box-shadow: none; }
        textarea { min-height: 140px; resize: vertical; }
        .panel .card-actions { justify-content: flex-end; padding-top: 6px; }
        button { border: none; border-radius: 999px; padding: 10px 18px; cursor: pointer; font-weight: 600; font-size: 0.95rem; background-color: var(--color-accent); color: #fff; transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 10px 22px rgba(0, 119, 182, 0.26); }
        button:hover { background-color: var(--color-navy); box-shadow: 0 12px 28px rgba(3, 4, 94, 0.28); }
        button:active { transform: scale(0.98); }
        button.button-secondary { background-color: var(--color-beige); color: var(--color-navy); box-shadow: none; }
        button.button-secondary:hover { background-color: var(--color-cream); }
        button.button-outline { background-color: transparent; color: var(--color-accent); border: 1px solid var(--color-border); box-shadow: none; }
        button.button-outline:hover { background-color: var(--color-accent-soft); }
        #back-button { background-color: var(--color-beige); color: var(--color-navy); box-shadow: none; }
        #back-button:hover { background-color: var(--color-cream); }
        .button-muted { background-color: #e5e7eb !important; color: #9aa0b4 !important; border-color: #d1d5db !important; box-shadow: none !important; }
        .button-muted:hover { background-color: #e5e7eb !important; }
        @media (max-width: 720px) {
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-body { padding: 0 20px 24px; }
            .panel { padding: 20px; }
        }
    </style>
</head>
<body>
<header>
    <h1>Expedientes Clínicos</h1>
</header>
<main>
    <section class="card" aria-live="polite">
        <div class="card-header">
            <div>
                <h2 id="page-title">Consentimiento informado</h2>
                <p id="patient-info" class="card-subtitle"></p>
            </div>
            <div class="card-actions">
                <span id="patient-status" class="status-chip" hidden>Estado</span>
                <button id="back-button" type="button" class="button-secondary">Volver a pacientes</button>
                <button id="back-expediente-button" type="button" class="button-outline">Volver al expediente</button>
            </div>
        </div>
        <div class="card-body">
            <p id="context-info" hidden></p>
            <div id="status-banner" class="status-banner"></div>
            <section class="panel" aria-labelledby="form-title">
                <h3 id="form-title">Registro de consentimiento</h3>
                <form id="consent-form">
                    <label class="form-field" for="alcance">Alcance del consentimiento
                        <textarea id="alcance" name="alcance" required></textarea>
                    </label>
                    <label class="form-field" for="riesgos">Riesgos y beneficios
                        <textarea id="riesgos" name="riesgos"></textarea>
                    </label>
                    <label class="form-field" for="aceptacion">Aceptación del paciente
                        <input id="aceptacion" name="aceptacion" type="text" placeholder="Acepto / No acepto" required>
                    </label>
                    <div class="card-actions">
                        <button id="edit-button" type="button" class="button-outline">Editar</button>
                        <button id="print-button" type="button" class="button-secondary">Imprimir</button>
                        <button id="save-button" type="submit" hidden>Guardar</button>
                    </div>
                </form>
            </section>
        </div>
    </section>
</main>
<script>
(function(){
    const DEFAULT_API_URL = "https://expedientesclinicos.onrender.com";
    const API_BASE_KEY = 'expedientesclinicos.apiBaseUrl';
    const ROLE_KEY = 'expedientesclinicos.role';
    const USER_ID_KEY = 'expedientesclinicos.usuarioId';
    const LEGACY_THERAPIST_KEY = 'expedientesclinicos.therapistId';

    let viewerId = null;
    let perfil = 'TERAPEUTA';
    let isAdmin = false;

    const STATUS_MAP = {
        ACTIVO: { text: 'Activo', className: 'estado-activo' },
        EN_ESPERA: { text: 'En espera', className: 'estado-en-espera' },
        ARCHIVADO: { text: 'Archivado', className: 'estado-archivado' }
    };

    let currentPatient = null;

    const isPatientArchived = function () {
        return Boolean(currentPatient && currentPatient.estado === 'ARCHIVADO');
    };

    const backButton = document.getElementById('back-button');
    const backExpedienteButton = document.getElementById('back-expediente-button');
    const patientInfo = document.getElementById('patient-info');
    const patientStatus = document.getElementById('patient-status');
    const statusBanner = document.getElementById('status-banner');
    const contextInfo = document.getElementById('context-info');
    const form = document.getElementById('consent-form');
    const editButton = document.getElementById('edit-button');
    const printButton = document.getElementById('print-button');
        printButton.addEventListener('click', async function(){
            if (Number.isNaN(pacienteId)) {
                statusBanner.textContent = 'Paciente no válido para imprimir.';
                statusBanner.classList.add('error');
                return;
            }
            statusBanner.textContent = 'Generando PDF...';
            statusBanner.classList.remove('error');
            try {
                const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId) + '/consentimiento/pdf');
                url.searchParams.set('usuarioId', therapistId);
                url.searchParams.set('perfil', perfil);
                const resp = await fetch(url.toString());
                if(!resp.ok){ throw new Error('Error ' + resp.status + ' al generar PDF'); }
                const blob = await resp.blob();
                const pdfUrl = URL.createObjectURL(blob);
                window.open(pdfUrl, '_blank');
                setTimeout(function(){ URL.revokeObjectURL(pdfUrl); }, 120000);
                statusBanner.textContent = 'PDF abierto en nueva pestaña.';
            } catch(err){
                statusBanner.textContent = err.message || 'No se pudo generar el PDF.';
                statusBanner.classList.add('error');
            }
        });
    const saveButton = document.getElementById('save-button');
    const CONSENT_FIELD_IDS = ['alcance', 'riesgos', 'aceptacion'];

    const setFieldsReadOnly = function (readOnly) {
        CONSENT_FIELD_IDS.forEach(function (id) {
            const element = document.getElementById(id);
            if (element) {
                element.readOnly = readOnly;
            }
        });
    };

    let editMode = false;

    const refreshEditButtonVisibility = function () {
        if (!editButton || isAdmin) {
            if (editButton) {
                editButton.hidden = true;
            }
            if (saveButton) {
                saveButton.hidden = true;
            }
            return;
        }
        if (isPatientArchived()) {
            editButton.hidden = true;
            if (saveButton) {
                saveButton.hidden = true;
            }
        } else {
            editButton.hidden = false;
            if (saveButton) {
                saveButton.hidden = !editMode;
            }
        }
    };

    function setEditMode(enabled){
        editMode = enabled;
        if (saveButton) {
            saveButton.hidden = !enabled;
        }
        if (editButton) {
            editButton.textContent = enabled ? 'Cancelar' : 'Editar';
        }
        setFieldsReadOnly(!enabled);
        refreshEditButtonVisibility();
    }

    if (editButton) {
        editButton.addEventListener('click', function(){
            if (isAdmin) {
                statusBanner.textContent = 'Solo el terapeuta puede editar el consentimiento.';
                statusBanner.classList.add('error');
                return;
            }
            if (isPatientArchived()) {
                statusBanner.textContent = 'El paciente se encuentra archivado; no es posible editar el consentimiento.';
                statusBanner.classList.remove('error');
                return;
            }
            setEditMode(!editMode);
        });
    }

    setEditMode(false);

    const params = new URLSearchParams(window.location.search);
    const pacienteIdParam = params.get('pacienteId');
    const pacienteId = pacienteIdParam ? Number(pacienteIdParam) : NaN;
    const terapeutaOrigenParam = params.get('terapeutaId');
    const terapeutaOrigenId = terapeutaOrigenParam ? Number(terapeutaOrigenParam) : NaN;

    const role = sessionStorage.getItem(ROLE_KEY);
    const isTherapist = role === 'TERAPEUTA';
    isAdmin = role === 'ADMINISTRADOR';
    if (!isTherapist && !isAdmin) {
        window.location.href = 'index.html';
        return;
    }

    let therapistIdRaw = sessionStorage.getItem(USER_ID_KEY);
    if (!therapistIdRaw && isTherapist) {
        const legacyId = sessionStorage.getItem(LEGACY_THERAPIST_KEY);
        if (legacyId) {
            therapistIdRaw = legacyId;
            sessionStorage.setItem(USER_ID_KEY, legacyId);
        }
    }
    if (!therapistIdRaw) {
        window.location.href = 'index.html';
        return;
    }
    viewerId = Number(therapistIdRaw);
    if (Number.isNaN(viewerId)) {
        statusBanner.textContent = 'La sesión actual no cuenta con un identificador válido.';
        statusBanner.classList.add('error');
        return;
    }
    perfil = isAdmin ? 'ADMINISTRADOR' : 'TERAPEUTA';
    const therapistId = viewerId;

    const updatePatientContext = function (patient) {
        currentPatient = patient || null;
        if (patientInfo) {
            if (patient && patient.nombreCompleto) {
                const servicio = patient.tipoServicio ? ' · ' + patient.tipoServicio.replace(/_/g, ' ').toLowerCase() : '';
                patientInfo.textContent = patient.nombreCompleto + servicio;
            } else {
                patientInfo.textContent = 'Paciente ID: ' + pacienteId;
            }
        }
        if (patientStatus) {
            if (patient && patient.estado) {
                const statusData = STATUS_MAP[patient.estado] || { text: patient.estado, className: '' };
                patientStatus.textContent = statusData.text;
                patientStatus.className = 'status-chip' + (statusData.className ? ' ' + statusData.className : '');
                patientStatus.hidden = false;
            } else {
                patientStatus.hidden = true;
            }
        }
        refreshEditButtonVisibility();
    };

    const fetchPatient = async function () {
        if (Number.isNaN(pacienteId)) {
            return null;
        }
        const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId));
        url.searchParams.set('usuarioId', therapistId);
        url.searchParams.set('perfil', perfil);
        const response = await fetch(url.toString());
        if (!response.ok) {
            throw new Error('Error ' + response.status + ' al obtener la información del paciente.');
        }
        const patient = await response.json();
        updatePatientContext(patient);
        return patient;
    };

    if (Number.isNaN(pacienteId)) {
        statusBanner.textContent = 'Selecciona un paciente desde la lista para registrar consentimiento.';
        statusBanner.classList.add('error');
    } else {
        patientInfo.textContent = 'Paciente ID: ' + pacienteId;
    }

    const apiBaseUrl = sessionStorage.getItem(API_BASE_KEY) || DEFAULT_API_URL;
    if (contextInfo) {
        contextInfo.textContent = '';
        contextInfo.hidden = !isAdmin;
    }

    if (isAdmin) {
        setFieldsReadOnly(true);
        refreshEditButtonVisibility();
    }

    backButton.addEventListener('click', function(){
        if (isAdmin) {
            if (!Number.isNaN(terapeutaOrigenId)) {
                window.location.href = 'terapeuta.html?terapeutaId=' + encodeURIComponent(terapeutaOrigenId);
                return;
            }
            window.location.href = 'panel_admin.html?view=patients';
            return;
        }
        window.location.href = 'pacientes.html';
    });

    const buildExpedienteUrl = function () {
        if (Number.isNaN(pacienteId)) {
            return null;
        }
        let target = 'expediente.html?pacienteId=' + encodeURIComponent(pacienteId);
        if (isAdmin && !Number.isNaN(terapeutaOrigenId)) {
            target += '&terapeutaId=' + encodeURIComponent(terapeutaOrigenId);
        }
        return target;
    };

    backExpedienteButton.addEventListener('click', function(){
        const target = buildExpedienteUrl();
        if (target) {
            window.location.href = target;
        }
    });

    async function cargarConsentimiento(){
        if (Number.isNaN(pacienteId)) {
            return 'invalid';
        }
        const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId) + '/consentimiento');
        url.searchParams.set('usuarioId', therapistId);
        url.searchParams.set('perfil', perfil);
        const response = await fetch(url.toString());
        if (response.status === 404) {
            document.getElementById('alcance').value = '';
            document.getElementById('riesgos').value = '';
            document.getElementById('aceptacion').value = '';
            return 'empty';
        }
        if (!response.ok) {
            throw new Error('Error ' + response.status + ' al obtener el consentimiento.');
        }
        const data = await response.json();
        document.getElementById('alcance').value = data.alcance || '';
        document.getElementById('riesgos').value = data.riesgos || '';
        document.getElementById('aceptacion').value = data.aceptacion || '';
        return 'loaded';
    }

    form.addEventListener('submit', async function(e){
        e.preventDefault();
        if (isAdmin) {
            statusBanner.textContent = 'Solo el terapeuta puede guardar el consentimiento.';
            statusBanner.classList.add('error');
            return;
        }
        if (!editMode) {
            statusBanner.textContent = 'Activa edición para guardar cambios.';
            statusBanner.classList.add('error');
            return;
        }
        if (isPatientArchived()) {
            statusBanner.textContent = 'El paciente está archivado; reactívalo para actualizar el consentimiento.';
            statusBanner.classList.remove('error');
            return;
        }
        if (Number.isNaN(pacienteId)) {
            statusBanner.textContent = 'No se puede guardar: paciente no válido.';
            statusBanner.classList.add('error');
            return;
        }
        statusBanner.textContent = 'Guardando consentimiento...';
        statusBanner.classList.remove('error');
        const payload = {
            solicitante: { usuarioId: therapistId, perfil: perfil },
            alcance: document.getElementById('alcance').value.trim(),
            riesgos: document.getElementById('riesgos').value.trim() || null,
            aceptacion: document.getElementById('aceptacion').value.trim()
        };
        const url = apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId) + '/consentimiento';
        try {
            const method = 'PUT';
            const resp = await fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if(!resp.ok){ throw new Error('Error ' + resp.status + ' al guardar consentimiento'); }
            statusBanner.textContent = 'Consentimiento guardado.';
            statusBanner.classList.remove('error');
            setEditMode(false);
        } catch(err){
            statusBanner.textContent = err.message || 'No fue posible guardar el consentimiento.';
            statusBanner.classList.add('error');
        }
    });

    const loadPage = async function () {
        if (Number.isNaN(pacienteId)) {
            refreshEditButtonVisibility();
            return;
        }
        statusBanner.textContent = 'Cargando consentimiento...';
        statusBanner.classList.remove('error');
        try {
            await fetchPatient();
            const result = await cargarConsentimiento();
            setEditMode(false);
            refreshEditButtonVisibility();
            if (result === 'empty') {
                statusBanner.textContent = 'Aún no hay consentimiento registrado.';
            } else {
                statusBanner.textContent = 'Consentimiento cargado.';
            }
        } catch (error) {
            statusBanner.textContent = error.message || 'No fue posible cargar el consentimiento.';
            statusBanner.classList.add('error');
            refreshEditButtonVisibility();
        }
    };

    loadPage();
})();
</script>
</body>
</html>
