<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Expediente del paciente - Expedientes Clínicos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            --color-navy: #555879;
            --color-navy-light: #98A1BC;
            --color-beige: #DED3C4;
            --color-cream: #F4EBD3;
            --color-text: #2f2f3a;
            --shadow-strong: rgba(85, 88, 121, 0.18);
            --shadow-soft: rgba(85, 88, 121, 0.12);
        }
        * { box-sizing: border-box; }
        body { margin:0; font-family:"Segoe UI", Arial, sans-serif; background-color: var(--color-cream); color: var(--color-text); }
        header { background-color: var(--color-navy); color:#fff; padding:16px 24px; }
        header h1 { margin:0; font-size:1.5rem; }
        main { max-width:1024px; margin:32px auto; padding:0 16px 56px; }
        .card { background:#fff; border-radius:16px; box-shadow:0 12px 28px var(--shadow-strong); border:1px solid rgba(152,161,188,.25); overflow:hidden; }
        .card-header { padding:24px 28px 12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:flex-start; gap:16px; }
        .card-header h2 { margin:0; font-size:1.6rem; }
        .card-header p { margin:4px 0 0; color: var(--color-navy-light); }
        .card-actions { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        .status-chip { display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px; background-color:rgba(152,161,188,.22); color:var(--color-navy); font-weight:600; font-size:.9rem; }
        .status-chip.estado-en-espera { background-color: rgba(222,211,196,.6); color:#8a775f; }
        .status-chip.estado-archivado { background-color: rgba(244,235,211,.7); color:#8f7d63; }
        .status-chip.estado-activo { background-color: rgba(85,88,121,.18); color: var(--color-navy); }
        .status-banner { margin:0 28px 16px; padding:10px 14px; border-radius:8px; background-color:rgba(152,161,188,.15); color:var(--color-navy); font-weight:600; min-height:24px; }
        .status-banner.error { background-color:#fdecea; color:#b3261e; }
        .panel { margin:0 28px 28px; background:#fff; border:1px solid rgba(152,161,188,.25); border-radius:12px; padding:20px 24px; box-shadow:0 4px 14px var(--shadow-soft); }
        dl.detail-list { display:grid; gap:12px; font-size:.95rem; }
        dl.detail-list dt { font-weight:600; }
        dl.detail-list dd { margin:4px 0 0; color: var(--color-navy-light); }
        .nav-buttons { display:flex; gap:12px; flex-wrap:wrap; margin:0 28px 28px; }
        button { border:none; border-radius:8px; padding:10px 18px; cursor:pointer; font-weight:600; font-size:.95rem; background: var(--color-navy); color:#fff; transition: background-color .2s ease, transform .2s ease; }
        button:hover { background-color:#404561; }
        button:active { transform: scale(.98); }
        button.button-secondary { background-color: var(--color-beige); color: var(--color-navy); }
        button.button-secondary:hover { background-color:#cfc2b1; }
        button.button-outline { background:transparent; color: var(--color-navy); border:1px solid var(--color-navy); }
        button.button-outline:hover { background-color: rgba(152,161,188,.2); }
        #back-button { background-color: var(--color-beige); color: var(--color-navy); }
        #back-button:hover { background-color:#cfc2b1; }
        @media (max-width:600px) {
            .card-header { flex-direction:column; align-items:flex-start; }
            .card-actions { width:100%; justify-content:flex-start; }
            .nav-buttons { flex-direction:column; }
        }
    </style>
</head>
<body>
<header>
    <h1>Expedientes Clínicos</h1>
</header>
<main>
    <section class="card" aria-live="polite">
        <div class="card-header">
            <div>
                <h2 id="patient-name">Paciente</h2>
                <p id="patient-service">Tipo de servicio</p>
            </div>
            <div class="card-actions">
                <span id="patient-status" class="status-chip" hidden>Estado</span>
                <button id="back-button" type="button" class="button-secondary">Volver a pacientes</button>
            </div>
        </div>
        <p id="context-info" hidden></p>
        <div id="status-banner" class="status-banner"></div>
        <div class="nav-buttons">
            <button id="go-sesiones" type="button" class="button-outline">Sesiones</button>
            <button id="go-entrevista" type="button" class="button-outline">Entrevista</button>
            <button id="go-consentimiento" type="button" class="button-outline">Consentimiento</button>
        </div>
        <section class="panel" aria-labelledby="detail-title">
            <h3 id="detail-title">Información básica</h3>
            <dl class="detail-list">
                <div><dt>Celular</dt><dd id="detail-celular">--</dd></div>
                <div><dt>Email</dt><dd id="detail-email">--</dd></div>
                <div><dt>Terapeuta asignado</dt><dd id="detail-terapeuta">--</dd></div>
                <div><dt>Fecha de registro</dt><dd id="detail-fecha-registro">--</dd></div>
                <div><dt>Próxima sesión</dt><dd id="detail-proxima-sesion">--</dd></div>
                <div><dt>Edad</dt><dd id="detail-edad">--</dd></div>
                <div><dt>Sexo</dt><dd id="detail-sexo">--</dd></div>
            </dl>
        </section>
    </section>
</main>
<script>
(function(){
    const DEFAULT_API_URL = "https://expedientesclinicos.onrender.com";
    const API_BASE_KEY = 'expedientesclinicos.apiBaseUrl';
    const USER_ID_KEY = 'expedientesclinicos.usuarioId';
    const ROLE_KEY = 'expedientesclinicos.role';
    const LEGACY_THERAPIST_KEY = 'expedientesclinicos.therapistId';

    const patientName = document.getElementById('patient-name');
    const patientService = document.getElementById('patient-service');
    const patientStatus = document.getElementById('patient-status');
    const statusBanner = document.getElementById('status-banner');
    const backButton = document.getElementById('back-button');
    const goSesiones = document.getElementById('go-sesiones');
    const goEntrevista = document.getElementById('go-entrevista');
    const goConsentimiento = document.getElementById('go-consentimiento');

    const detail = {
        celular: document.getElementById('detail-celular'),
        email: document.getElementById('detail-email'),
        terapeuta: document.getElementById('detail-terapeuta'),
        fechaRegistro: document.getElementById('detail-fecha-registro'),
        proximaSesion: document.getElementById('detail-proxima-sesion'),
        edad: document.getElementById('detail-edad'),
        sexo: document.getElementById('detail-sexo')
    };

    const params = new URLSearchParams(window.location.search);
    const pacienteParam = params.get('pacienteId');
    const pacienteId = pacienteParam ? Number(pacienteParam) : NaN;

    const role = sessionStorage.getItem(ROLE_KEY);
    if (role !== 'TERAPEUTA') {
        window.location.href = 'index.html';
        return;
    }
    let therapistIdRaw = sessionStorage.getItem(USER_ID_KEY);
    if (!therapistIdRaw) {
        const legacyId = sessionStorage.getItem(LEGACY_THERAPIST_KEY);
        if (legacyId) {
            therapistIdRaw = legacyId;
            sessionStorage.setItem(USER_ID_KEY, legacyId);
        }
    }
    if (!therapistIdRaw) {
        window.location.href = 'index.html';
        return;
    }
    const therapistId = Number(therapistIdRaw);
    if (Number.isNaN(therapistId)) {
        statusBanner.textContent = 'ID de terapeuta inválido.';
        statusBanner.classList.add('error');
        return;
    }

    if (Number.isNaN(pacienteId)) {
        statusBanner.textContent = 'Selecciona un paciente desde la lista.';
        statusBanner.classList.add('error');
    }

    const apiBaseUrl = sessionStorage.getItem(API_BASE_KEY) || DEFAULT_API_URL;

    const SERVICE_LABELS = {
        TERAPIA_INDIVIDUAL:'Psicoterapia', TERAPIA_FAMILIAR:'Terapia familiar', TERAPIA_PAREJA:'Terapia de pareja',
        TERAPIA_GRUPAL:'Terapia grupal', EVALUACION_PSICOLOGICA:'Psicodiagnóstico', INTERVENCION_CRISIS:'Intervención en crisis'
    };
    const SEX_LABELS = { FEMENINO:'Femenino', MASCULINO:'Masculino', NO_BINARIO:'No binario', PREFIERE_NO_DECIR:'Prefiere no decir' };
    const STATUS_MAP = {
        ACTIVO:{text:'Activo', className:'estado-activo'},
        EN_ESPERA:{text:'En espera', className:'estado-en-espera'},
        ARCHIVADO:{text:'Archivado', className:'estado-archivado'}
    };

    function fmtService(s){ return SERVICE_LABELS[s] || (s||'').replace(/_/g,' ').toLowerCase() || 'Sin tipo'; }
    function fmtSexo(s){ return SEX_LABELS[s] || s || '--'; }
    function fmtDate(v){ if(!v) return '--'; try { const d = new Date(v+'T00:00:00'); return new Intl.DateTimeFormat('es-MX',{day:'2-digit',month:'2-digit',year:'numeric'}).format(d);} catch(e){ return v; } }

    async function fetchPatient(){
        if (Number.isNaN(pacienteId)) return null;
        const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(pacienteId));
        url.searchParams.set('usuarioId', therapistId);
        url.searchParams.set('perfil', 'TERAPEUTA');
        const resp = await fetch(url.toString());
        if(!resp.ok) throw new Error('Error '+resp.status+' al obtener paciente');
        return resp.json();
    }

    function renderPatient(p){
        if(!p){ return; }
        patientName.textContent = p.nombreCompleto || 'Paciente sin nombre';
        patientService.textContent = fmtService(p.tipoServicio);
        const st = STATUS_MAP[p.estado];
        if(st){ patientStatus.textContent = st.text; patientStatus.className = 'status-chip '+st.className; patientStatus.hidden = false; }
        detail.celular.textContent = p.celular || '--';
        detail.email.textContent = p.email || '--';
        detail.terapeuta.textContent = (p.terapeutaAsignado && p.terapeutaAsignado.nombre) ? p.terapeutaAsignado.nombre : '--';
        detail.fechaRegistro.textContent = fmtDate(p.fechaRegistro);
        detail.proximaSesion.textContent = fmtDate(p.fechaProximaSesion);
        detail.edad.textContent = (p.edad!==null && p.edad!==undefined) ? p.edad + ' años' : '--';
        detail.sexo.textContent = fmtSexo(p.sexo);
    }

    async function load(){
        statusBanner.textContent = 'Cargando expediente...';
        statusBanner.classList.remove('error');
        try {
            const patient = await fetchPatient();
            if(patient){
                renderPatient(patient);
                const ts = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                statusBanner.textContent = 'Expediente cargado ('+ts+').';
            }
        } catch(err){
            statusBanner.textContent = err.message || 'No fue posible cargar el expediente.';
            statusBanner.classList.add('error');
        }
    }

    backButton.addEventListener('click', () => { window.location.href = 'pacientes.html'; });
    goSesiones.addEventListener('click', () => { if(!Number.isNaN(pacienteId)) window.location.href = 'sesiones.html?pacienteId=' + encodeURIComponent(pacienteId); });
    goEntrevista.addEventListener('click', () => { if(!Number.isNaN(pacienteId)) window.location.href = 'entrevista.html?pacienteId=' + encodeURIComponent(pacienteId); });
    goConsentimiento.addEventListener('click', () => { if(!Number.isNaN(pacienteId)) window.location.href = 'consentimiento.html?pacienteId=' + encodeURIComponent(pacienteId); });

    load();
})();
</script>
</body>
</html>