<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Detalle de terapeuta - Expedientes Clínicos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            --color-navy: #555879;
            --color-navy-light: #98A1BC;
            --color-beige: #DED3C4;
            --color-cream: #F4EBD3;
            --color-text: #2f2f3a;
            --shadow-strong: rgba(85, 88, 121, 0.18);
            --shadow-soft: rgba(85, 88, 121, 0.12);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background-color: var(--color-cream); color: var(--color-text); }
        header { background-color: var(--color-navy); color: #fff; padding: 16px 24px; }
        header h1 { margin: 0; font-size: 1.5rem; }
        main { max-width: 880px; margin: 32px auto; padding: 0 16px 48px; }
        .card { background-color: #fff; border-radius: 16px; box-shadow: 0 12px 28px var(--shadow-strong); overflow: hidden; border: 1px solid rgba(152, 161, 188, 0.25); }
        .card-header { padding: 24px 28px 16px; display: flex; flex-wrap: wrap; justify-content: space-between; gap: 16px; align-items: flex-start; }
        .card-header h2 { margin: 0; font-size: 1.6rem; }
        .card-header p { margin: 4px 0 0; color: var(--color-navy-light); }
        .card-actions { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .status-banner { margin: 0 28px 16px; padding: 10px 14px; border-radius: 8px; background-color: rgba(152, 161, 188, 0.15); color: var(--color-navy); font-weight: 600; min-height: 24px; }
        .status-banner.error { background-color: #fdecea; color: #b3261e; }
        .panel { margin: 0 28px 28px; border: 1px solid rgba(152, 161, 188, 0.25); border-radius: 12px; padding: 24px; box-shadow: 0 4px 14px var(--shadow-soft); background-color: #fff; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .panel-actions-inline { display: flex; gap: 10px; flex-wrap: wrap; }
        .detail-list { margin: 20px 0 0; display: grid; gap: 14px; font-size: 0.95rem; }
        .detail-list div { display: grid; gap: 4px; }
        .detail-list dt { font-weight: 600; color: var(--color-text); }
        .detail-list dd { margin: 0; color: var(--color-navy-light); }
        .panel-status { margin: 16px 0 0; font-size: 0.95rem; color: var(--color-navy); min-height: 24px; }
        .panel-status.error { color: #b3261e; }
        .selector-list { list-style: none; margin: 20px 0 0; padding: 0; }
        .selector-row { display: flex; justify-content: space-between; align-items: center; gap: 16px; padding: 18px 22px; border-top: 1px solid rgba(152, 161, 188, 0.25); cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; }
        .selector-row:first-of-type { border-top: none; }
        .selector-row:hover { background-color: rgba(152, 161, 188, 0.16); }
        .selector-row:focus { outline: 2px solid var(--color-navy); outline-offset: 2px; background-color: rgba(152, 161, 188, 0.24); }
        .selector-row:active { transform: scale(0.99); }
        .selector-info { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        .selector-name { font-size: 1.05rem; font-weight: 600; color: var(--color-text); }
        .selector-meta { font-size: 0.95rem; color: var(--color-navy-light); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .selector-actions { display: flex; align-items: center; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        .status-chip { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 999px; font-weight: 600; font-size: 0.85rem; border: 1px solid transparent; background-color: rgba(152, 161, 188, 0.18); color: var(--color-navy); }
        .status-chip.estado-activo { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .status-chip.estado-en-espera { background-color: rgba(152, 161, 188, 0.22); color: var(--color-navy); border-color: rgba(152, 161, 188, 0.3); }
        .status-chip.estado-archivado { background-color: #fef3c7; color: #92400e; border-color: #fde68a; }
        .empty-state { margin: 20px 0 0; padding: 18px; border-radius: 10px; background-color: rgba(244, 235, 211, 0.85); color: var(--color-navy); }
        button { border: none; border-radius: 8px; padding: 10px 18px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: background-color 0.2s ease, transform 0.2s ease; background-color: var(--color-navy); color: #fff; }
        button:hover { background-color: #404561; }
        button:active { transform: scale(0.98); }
        .button-secondary { background-color: var(--color-beige); color: var(--color-navy); }
        .button-secondary:hover { background-color: #cfc2b1; }
        .button-danger { background-color: #dc2626; color: #fff; }
        .button-danger:hover { background-color: #b91c1c; }
        #back-button { background-color: var(--color-beige); color: var(--color-navy); }
        #back-button:hover { background-color: #cfc2b1; }
        input[type="text"], input[type="email"] { width: 100%; border: 1px solid rgba(152, 161, 188, 0.6); border-radius: 8px; padding: 10px 12px; font-size: 0.95rem; color: var(--color-text); background-color: #fff; }
        input:focus { outline: 2px solid var(--color-navy); }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(85, 88, 121, 0.56); display: flex; align-items: center; justify-content: center; padding: 16px; z-index: 1000; }
        .modal-backdrop[hidden] { display: none; }
        .modal { background-color: #fff; border-radius: 12px; box-shadow: 0 18px 38px rgba(85, 88, 121, 0.24); max-width: 420px; width: 100%; padding: 24px 26px; border: 1px solid rgba(152, 161, 188, 0.3); }
        .modal h3 { margin: 0 0 12px; font-size: 1.2rem; color: var(--color-text); }
        .modal p { margin: 0 0 18px; font-size: 0.95rem; color: var(--color-navy-light); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button { border-radius: 8px; padding: 10px 16px; font-weight: 600; font-size: 0.95rem; }
        .modal-actions .button-secondary { background-color: var(--color-beige); color: var(--color-navy); }
        .modal-actions .button-secondary:hover { background-color: #cfc2b1; }
        .modal-actions .button-danger { background-color: #dc2626; color: #fff; }
        .modal-actions .button-danger:hover { background-color: #b91c1c; }
        @media (max-width: 600px) {
            .card-header { flex-direction: column; align-items: flex-start; }
            .panel { margin: 0 16px 24px; padding: 20px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Expedientes Clínicos</h1>
    </header>
    <main>
        <section class="card" aria-live="polite">
            <div class="card-header">
                <div>
                    <h2 id="therapist-name">Terapeuta</h2>
                    <p id="therapist-specialty">Especialidad</p>
                </div>
                <div class="card-actions">
                    <button id="back-button" type="button" class="button-secondary">Volver a terapeutas</button>
                </div>
            </div>
            <div id="status-banner" class="status-banner"></div>
            <section class="panel" aria-labelledby="basic-title">
                <div class="panel-header">
                    <h3 id="basic-title">Información básica</h3>
                    <div class="panel-actions-inline">
                        <button id="edit-button" type="button" class="button-secondary">Editar</button>
                        <button id="delete-button" type="button" class="button-danger">Eliminar</button>
                    </div>
                </div>
                <dl class="detail-list">
                    <div>
                        <dt>ID</dt>
                        <dd id="detail-id">--</dd>
                    </div>
                    <div>
                        <dt>Nombre completo</dt>
                        <dd id="detail-nombre">--</dd>
                    </div>
                    <div>
                        <dt>Correo electrónico</dt>
                        <dd id="detail-correo">--</dd>
                    </div>
                    <div>
                        <dt>Especialidad</dt>
                        <dd id="detail-especialidad">--</dd>
                    </div>
                    <div>
                        <dt>Cédula profesional</dt>
                        <dd id="detail-cedula">--</dd>
                    </div>
                    <div>
                        <dt>Teléfono</dt>
                        <dd id="detail-telefono">--</dd>
                    </div>
                </dl>
            </section>
            <section id="patient-panel" class="panel" aria-labelledby="patient-title">
                <div class="panel-header">
                    <h3 id="patient-title">Pacientes asignados</h3>
                    <div class="panel-actions-inline">
                        <button id="refresh-patients-button" type="button" class="button-secondary">Actualizar</button>
                    </div>
                </div>
                <p id="patient-status-text" class="panel-status"></p>
                <ul id="patient-list" class="selector-list"></ul>
                <p id="patient-empty-state" class="empty-state" hidden>No hay pacientes asignados al terapeuta.</p>
            </section>
        </section>
    </main>

    <div id="delete-modal-backdrop" class="modal-backdrop" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title">
            <h3 id="delete-modal-title">Eliminar terapeuta</h3>
            <p id="delete-modal-message">Confirma si deseas eliminar al terapeuta.</p>
            <div class="modal-actions">
                <button id="delete-cancel-button" type="button" class="button-secondary">Cancelar</button>
                <button id="delete-confirm-button" type="button" class="button-danger">Eliminar</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const DEFAULT_API_URL = "https://expedientesclinicos.onrender.com";
            const API_BASE_KEY = 'expedientesclinicos.apiBaseUrl';
            const USER_ID_KEY = 'expedientesclinicos.usuarioId';
            const ROLE_KEY = 'expedientesclinicos.role';
            const LEGACY_THERAPIST_KEY = 'expedientesclinicos.therapistId';

            const therapistNameEl = document.getElementById('therapist-name');
            const therapistSpecialtyEl = document.getElementById('therapist-specialty');
            const statusBanner = document.getElementById('status-banner');
            const editButton = document.getElementById('edit-button');
            const deleteButton = document.getElementById('delete-button');
            const backButton = document.getElementById('back-button');

            const detailFields = {
                id: document.getElementById('detail-id'),
                nombre: document.getElementById('detail-nombre'),
                correo: document.getElementById('detail-correo'),
                especialidad: document.getElementById('detail-especialidad'),
                cedulaProfesional: document.getElementById('detail-cedula'),
                telefono: document.getElementById('detail-telefono')
            };

            const patientPanel = document.getElementById('patient-panel');
            const patientStatusText = document.getElementById('patient-status-text');
            const patientListEl = document.getElementById('patient-list');
            const patientEmptyState = document.getElementById('patient-empty-state');
            const refreshPatientsButton = document.getElementById('refresh-patients-button');

            const SERVICE_LABELS = {
                TERAPIA_INDIVIDUAL: 'Psicoterapia',
                TERAPIA_FAMILIAR: 'Terapia familiar',
                TERAPIA_PAREJA: 'Terapia de pareja',
                TERAPIA_GRUPAL: 'Terapia grupal',
                EVALUACION_PSICOLOGICA: 'Psicodiagnóstico',
                INTERVENCION_CRISIS: 'Intervención en crisis'
            };

            const STATUS_LABELS = {
                ACTIVO: 'Activo',
                EN_ESPERA: 'En espera',
                ARCHIVADO: 'Archivado'
            };
            const STATUS_STYLES = {
                ACTIVO: 'estado-activo',
                EN_ESPERA: 'estado-en-espera',
                ARCHIVADO: 'estado-archivado'
            };

            const deleteModalBackdrop = document.getElementById('delete-modal-backdrop');
            const deleteModalMessage = document.getElementById('delete-modal-message');
            const deleteCancelButton = document.getElementById('delete-cancel-button');
            const deleteConfirmButton = document.getElementById('delete-confirm-button');

            const role = sessionStorage.getItem(ROLE_KEY);
            if (role !== 'ADMINISTRADOR') {
                window.location.href = 'index.html';
                return;
            }

            const adminIdRaw = sessionStorage.getItem(USER_ID_KEY);
            if (!adminIdRaw) {
                window.location.href = 'index.html';
                return;
            }

            const adminId = Number(adminIdRaw);
            if (Number.isNaN(adminId)) {
                sessionStorage.removeItem(USER_ID_KEY);
                sessionStorage.removeItem(ROLE_KEY);
                sessionStorage.removeItem(LEGACY_THERAPIST_KEY);
                window.location.href = 'index.html';
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const terapeutaParam = params.get('terapeutaId');
            const terapeutaId = terapeutaParam ? Number(terapeutaParam) : NaN;

            if (Number.isNaN(terapeutaId)) {
                statusBanner.textContent = 'Selecciona un terapeuta desde la lista para ver su información.';
                statusBanner.classList.add('error');
                editButton.disabled = true;
                deleteButton.disabled = true;
                if (patientPanel) {
                    patientPanel.hidden = true;
                }
                if (refreshPatientsButton) {
                    refreshPatientsButton.disabled = true;
                }
                return;
            }

            const apiBaseUrl = sessionStorage.getItem(API_BASE_KEY) || DEFAULT_API_URL;

            let currentTherapist = null;
            let isEditing = false;
            const fieldEditors = {};

            const updateDetailView = function () {
                if (!currentTherapist) {
                    return;
                }
                const safeValue = function (value) {
                    if (value === null || value === undefined || String(value).trim() === '') {
                        return '--';
                    }
                    return String(value).trim();
                };
                detailFields.id.textContent = currentTherapist.id !== undefined && currentTherapist.id !== null ? currentTherapist.id : '--';
                detailFields.nombre.textContent = safeValue(currentTherapist.nombre);
                detailFields.correo.textContent = safeValue(currentTherapist.correo);
                detailFields.especialidad.textContent = safeValue(currentTherapist.especialidad);
                detailFields.cedulaProfesional.textContent = safeValue(currentTherapist.cedulaProfesional);
                detailFields.telefono.textContent = safeValue(currentTherapist.telefono);
            };

            const renderTherapist = function (therapist) {
                currentTherapist = therapist;
                therapistNameEl.textContent = therapist.nombre || 'Terapeuta sin nombre';
                therapistSpecialtyEl.textContent = therapist.especialidad ? therapist.especialidad : 'Sin especialidad registrada';
                if (!isEditing) {
                    updateDetailView();
                }
            };

            const createEditorForField = function (key, label, type, required) {
                const field = detailFields[key];
                if (!field) {
                    return;
                }
                field.innerHTML = '';
                const input = document.createElement('input');
                input.type = type || 'text';
                const rawValue = currentTherapist ? currentTherapist[key] : null;
                if (rawValue !== null && rawValue !== undefined) {
                    input.value = String(rawValue).trim();
                }
                if (type === 'email') {
                    input.autocomplete = 'email';
                }
                if (key === 'telefono') {
                    input.placeholder = 'Ej. 555-123-4567';
                }
                if (required) {
                    input.required = true;
                }
                input.setAttribute('data-field', key);
                field.appendChild(input);
                fieldEditors[key] = { element: input, required: required, label: label };
            };

            const enterEditMode = function () {
                if (isEditing || !currentTherapist) {
                    return;
                }
                isEditing = true;
                renderTherapist(currentTherapist);
                createEditorForField('nombre', 'Nombre completo', 'text', true);
                createEditorForField('correo', 'Correo electrónico', 'email', true);
                createEditorForField('especialidad', 'Especialidad', 'text', true);
                createEditorForField('cedulaProfesional', 'Cédula profesional', 'text', true);
                createEditorForField('telefono', 'Teléfono', 'text', false);
                editButton.textContent = 'Guardar';
                statusBanner.textContent = 'Modo edición activado. Guarda los cambios para persistirlos.';
                statusBanner.classList.remove('error');
            };

            const resetEditors = function () {
                Object.keys(fieldEditors).forEach(function (key) {
                    delete fieldEditors[key];
                });
            };

            const exitEditMode = function () {
                if (!isEditing) {
                    return;
                }
                isEditing = false;
                editButton.textContent = 'Editar';
                resetEditors();
                updateDetailView();
            };

            const collectUpdateValues = function () {
                const updates = {};
                let hasChanges = false;
                const keys = Object.keys(fieldEditors);
                for (let i = 0; i < keys.length; i += 1) {
                    const key = keys[i];
                    const editor = fieldEditors[key].element;
                    const required = fieldEditors[key].required;
                    const label = fieldEditors[key].label;
                    let value = editor.value;
                    if (typeof value === 'string') {
                        value = value.trim();
                    }
                    if (!value && required) {
                        throw new Error('El campo ' + label + ' es obligatorio.');
                    }
                    if (!value && !required) {
                        value = null;
                    }
                    updates[key] = value;
                    const currentValue = currentTherapist ? currentTherapist[key] : null;
                    const normalizedCurrent = currentValue === undefined || currentValue === null || String(currentValue).trim() === '' ? null : String(currentValue).trim();
                    const normalizedValue = value === undefined || value === null || value === '' ? null : String(value);
                    if (!hasChanges && normalizedCurrent !== normalizedValue) {
                        hasChanges = true;
                    }
                }
                return { updates: updates, hasChanges: hasChanges };
            };

            const buildUpdatePayload = function (overrides) {
                const base = currentTherapist || {};
                return {
                    nombre: overrides.nombre !== undefined ? overrides.nombre : (base.nombre || ''),
                    correo: overrides.correo !== undefined ? overrides.correo : (base.correo || ''),
                    especialidad: overrides.especialidad !== undefined ? overrides.especialidad : (base.especialidad || ''),
                    cedulaProfesional: overrides.cedulaProfesional !== undefined ? overrides.cedulaProfesional : (base.cedulaProfesional || ''),
                    telefono: overrides.telefono !== undefined ? overrides.telefono : (base.telefono || null)
                };
            };

            const saveUpdates = async function () {
                try {
                    const result = collectUpdateValues();
                    if (!result.hasChanges) {
                        statusBanner.textContent = 'No se detectaron cambios para guardar.';
                        statusBanner.classList.remove('error');
                        exitEditMode();
                        return;
                    }
                    statusBanner.textContent = 'Guardando información del terapeuta...';
                    statusBanner.classList.remove('error');
                    const payload = buildUpdatePayload(result.updates);
                    const response = await fetch(apiBaseUrl + '/api/terapeutas/' + encodeURIComponent(terapeutaId), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error('Error ' + response.status + ' al actualizar el terapeuta.');
                    }
                    const updated = await response.json();
                    renderTherapist(updated);
                    exitEditMode();
                    statusBanner.textContent = 'Terapeuta actualizado correctamente.';
                    statusBanner.classList.remove('error');
                } catch (error) {
                    statusBanner.textContent = error.message || 'No fue posible actualizar el terapeuta.';
                    statusBanner.classList.add('error');
                }
            };

            const fetchTherapist = async function () {
                const response = await fetch(apiBaseUrl + '/api/terapeutas/' + encodeURIComponent(terapeutaId));
                if (!response.ok) {
                    throw new Error('Error ' + response.status + ' al obtener el terapeuta.');
                }
                return response.json();
            };

            const formatService = function (service) {
                if (!service) {
                    return 'Sin tipo';
                }
                return SERVICE_LABELS[service] || service.replace(/_/g, ' ').toLowerCase();
            };

            const formatStatus = function (status) {
                const label = status ? (STATUS_LABELS[status] || status) : 'Sin estado';
                const className = status ? (STATUS_STYLES[status] || '') : '';
                return { text: label, className: className };
            };

            const openPatientDetail = function (patientId, options) {
                if (patientId === undefined || patientId === null) {
                    return;
                }
                let target = 'expediente.html?pacienteId=' + encodeURIComponent(patientId);
                if (!Number.isNaN(terapeutaId)) {
                    target += '&terapeutaId=' + encodeURIComponent(terapeutaId);
                }
                if (options && options.edit) {
                    target += '&editar=1';
                }
                window.location.href = target;
            };

            const renderPatients = function (patients) {
                patientListEl.innerHTML = '';
                if (!Array.isArray(patients) || !patients.length) {
                    patientEmptyState.hidden = false;
                    return;
                }
                patientEmptyState.hidden = true;
                const fragment = document.createDocumentFragment();
                patients.forEach(function (patient) {
                    const li = document.createElement('li');
                    li.className = 'selector-row';
                    li.setAttribute('role', 'button');
                    li.setAttribute('tabindex', '0');

                    const info = document.createElement('div');
                    info.className = 'selector-info';

                    const name = document.createElement('span');
                    name.className = 'selector-name';
                    name.textContent = patient.nombreCompleto || 'Paciente sin nombre';

                    const meta = document.createElement('span');
                    meta.className = 'selector-meta';
                    meta.textContent = formatService(patient.tipoServicio);

                    info.appendChild(name);
                    info.appendChild(meta);

                    const actions = document.createElement('div');
                    actions.className = 'selector-actions';

                    const statusInfo = formatStatus(patient.estado);
                    const status = document.createElement('span');
                    status.className = 'status-chip' + (statusInfo.className ? ' ' + statusInfo.className : '');
                    status.textContent = statusInfo.text;
                    actions.appendChild(status);

                    const handleNavigation = function () {
                        if (patient.id !== undefined && patient.id !== null) {
                            openPatientDetail(patient.id);
                        }
                    };

                    li.addEventListener('click', handleNavigation);
                    li.addEventListener('keydown', function (event) {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            handleNavigation();
                        }
                    });

                    li.appendChild(info);
                    li.appendChild(actions);
                    fragment.appendChild(li);
                });
                patientListEl.appendChild(fragment);
            };

            const loadPatients = async function () {
                if (Number.isNaN(terapeutaId)) {
                    return;
                }
                patientStatusText.textContent = 'Cargando pacientes...';
                patientStatusText.classList.remove('error');
                try {
                    const url = new URL(apiBaseUrl + '/api/pacientes/terapeutas/' + encodeURIComponent(terapeutaId));
                    url.searchParams.set('usuarioId', adminId);
                    url.searchParams.set('perfil', 'ADMINISTRADOR');
                    const response = await fetch(url.toString());
                    if (!response.ok) {
                        throw new Error('Error ' + response.status + ' al obtener los pacientes.');
                    }
                    const payload = await response.json();
                    renderPatients(Array.isArray(payload) ? payload : []);
                    const timeStamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    patientStatusText.textContent = 'Lista actualizada (' + timeStamp + ').';
                } catch (error) {
                    patientStatusText.textContent = error.message || 'No fue posible cargar los pacientes.';
                    patientStatusText.classList.add('error');
                    renderPatients([]);
                }
            };

            const loadTherapist = async function () {
                statusBanner.textContent = 'Cargando información...';
                statusBanner.classList.remove('error');
                try {
                    const therapist = await fetchTherapist();
                    renderTherapist(therapist);
                    updateDetailView();
                    statusBanner.textContent = 'Datos actualizados correctamente.';
                    loadPatients();
                } catch (error) {
                    statusBanner.textContent = error.message || 'No fue posible cargar la información del terapeuta.';
                    statusBanner.classList.add('error');
                    editButton.disabled = true;
                    deleteButton.disabled = true;
                    patientPanel.hidden = true;
                }
            };

            const openDeleteModal = function () {
                if (!currentTherapist) {
                    return;
                }
                deleteModalMessage.textContent = 'Estas a punto de eliminar al terapeuta "' + (currentTherapist.nombre || 'sin nombre') + '". Esta accion no se puede deshacer.';
                deleteModalBackdrop.hidden = false;
            };

            const closeDeleteModal = function () {
                deleteModalBackdrop.hidden = true;
            };

            const deleteTherapist = async function () {
                if (!currentTherapist) {
                    return;
                }
                deleteConfirmButton.disabled = true;
                deleteCancelButton.disabled = true;
                statusBanner.textContent = 'Eliminando terapeuta...';
                statusBanner.classList.remove('error');
                try {
                    const response = await fetch(apiBaseUrl + '/api/terapeutas/' + encodeURIComponent(terapeutaId), {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        throw new Error('Error ' + response.status + ' al eliminar el terapeuta.');
                    }
                    closeDeleteModal();
                    window.location.href = 'panel_admin.html';
                } catch (error) {
                    statusBanner.textContent = error.message || 'No fue posible eliminar al terapeuta.';
                    statusBanner.classList.add('error');
                    deleteConfirmButton.disabled = false;
                    deleteCancelButton.disabled = false;
                }
            };

            editButton.addEventListener('click', function () {
                if (isEditing) {
                    saveUpdates();
                } else {
                    enterEditMode();
                }
            });

            deleteButton.addEventListener('click', openDeleteModal);
            deleteCancelButton.addEventListener('click', function () {
                deleteConfirmButton.disabled = false;
                deleteCancelButton.disabled = false;
                closeDeleteModal();
            });
            deleteConfirmButton.addEventListener('click', deleteTherapist);

            deleteModalBackdrop.addEventListener('click', function (event) {
                if (event.target === deleteModalBackdrop) {
                    deleteConfirmButton.disabled = false;
                    deleteCancelButton.disabled = false;
                    closeDeleteModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    if (!deleteModalBackdrop.hidden) {
                        deleteConfirmButton.disabled = false;
                        deleteCancelButton.disabled = false;
                        closeDeleteModal();
                        return;
                    }
                    if (isEditing) {
                        exitEditMode();
                        statusBanner.textContent = 'Edición cancelada. No se guardaron cambios.';
                        statusBanner.classList.remove('error');
                    }
                }
            });

            backButton.addEventListener('click', function () {
                window.location.href = 'panel_admin.html';
            });

            if (refreshPatientsButton) {
                refreshPatientsButton.addEventListener('click', loadPatients);
            }

            loadTherapist();
        })();
    </script>
</body>
</html>
