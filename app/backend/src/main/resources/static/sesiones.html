<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sesiones clínicas - Expedientes Clínicos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            color-scheme: light;
            --color-navy: #03045e;
            --color-navy-light: rgba(3, 4, 94, 0.72);
            --color-beige: #90e0ef;
            --color-cream: #caf0f8;
            --color-accent: #0077b6;
            --color-accent-soft: rgba(0, 180, 216, 0.16);
            --color-border: #00b4d8;
            --color-text: #03045e;
            --shadow-strong: rgba(0, 180, 216, 0.24);
            --shadow-soft: rgba(0, 180, 216, 0.16);
            --color-danger: #b91c1c;
            --color-background-falloff: #edf2f4;
            --color-background-glow: rgba(237, 242, 244, 0.52);
            --state-active-bg: #dcfce7;
            --state-active-text: #166534;
            --state-active-border: #bbf7d0;
            --state-pending-bg: #e0f2fe;
            --state-pending-text: #0369a1;
            --state-pending-border: #bae6fd;
            --state-archived-bg: #fef3c7;
            --state-archived-text: #92400e;
            --state-archived-border: #fde68a;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background-color: var(--color-background-falloff);
            background-image: radial-gradient(120% 140% at 50% -20%, var(--color-background-glow), rgba(237, 242, 244, 0.95) 62%, rgba(237, 242, 244, 0.98) 100%);
            color: var(--color-text);
        }
        header { background-color: var(--color-navy); color: #fff; padding: 16px 24px; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18); }
        header h1 { margin: 0; font-size: 1.5rem; }
        main { max-width: 1024px; margin: 32px auto; padding: 0 16px 48px; }
        .card { background-color: var(--color-cream); border-radius: 20px; box-shadow: 0 20px 44px var(--shadow-strong); overflow: hidden; border: 1px solid var(--color-border); backdrop-filter: blur(6px); }
        .card-header { padding: 24px 28px 16px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 16px; }
        .card-header h2 { margin: 0; font-size: 1.6rem; }
        .card-header p { margin: 4px 0 0; color: var(--color-navy-light); }
        .card-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .status-chip { display: inline-flex; align-items: center; padding: 6px 14px; border-radius: 999px; font-weight: 600; font-size: 0.9rem; border: 1px solid var(--state-active-border); background-color: var(--state-active-bg); color: var(--state-active-text); }
        .status-chip.estado-activo { background-color: var(--state-active-bg); color: var(--state-active-text); border-color: var(--state-active-border); }
        .status-chip.estado-en-espera { background-color: var(--state-pending-bg); color: var(--state-pending-text); border-color: var(--state-pending-border); }
        .status-chip.estado-archivado { background-color: var(--state-archived-bg); color: var(--state-archived-text); border-color: var(--state-archived-border); }
        .status-banner { margin: 0 28px 16px; padding: 12px 16px; border-radius: 12px; background-color: var(--color-accent-soft); color: var(--color-accent); font-weight: 600; min-height: 24px; }
        .status-banner.error { background-color: rgba(185, 28, 28, 0.12); color: var(--color-danger); }
        .detail-grid { display: flex; flex-direction: column; gap: 20px; padding: 0 28px 28px; }
        .panel { background-color: rgba(255, 255, 255, 0.9); border: 1px solid var(--color-border); border-radius: 16px; padding: 22px 26px; box-shadow: 0 12px 30px var(--shadow-soft); backdrop-filter: blur(4px); }
        .panel h3 { margin: 0 0 16px; font-size: 1.1rem; color: var(--color-text); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 16px; }
        .panel-header h3 { margin: 0; }
        .panel-actions-inline { display: flex; gap: 10px; flex-wrap: wrap; }
        .sessions-panel { width: 100%; }
        .session-grid { list-style: none; margin: 0; padding: 0; display: grid; gap: 12px; }
        .session-card { border: 1px solid var(--color-border); border-radius: 14px; padding: 16px 18px; background-color: rgba(144, 224, 239, 0.3); box-shadow: 0 8px 22px rgba(0, 180, 216, 0.18); display: flex; flex-direction: column; gap: 12px; backdrop-filter: blur(4px); }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .session-number { font-weight: 700; font-size: 1rem; color: var(--color-text); }
        .session-status { font-weight: 600; font-size: 0.9rem; padding: 4px 12px; border-radius: 999px; border: 1px solid transparent; }
        .session-status.asistio { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .session-status.cancelada { background-color: rgba(3, 4, 94, 0.1); color: rgba(3, 4, 94, 0.72); border-color: rgba(3, 4, 94, 0.18); }
        .session-status.falta { background-color: rgba(0, 180, 216, 0.18); color: var(--color-accent); border-color: rgba(0, 180, 216, 0.3); }
        .session-body p { margin: 6px 0; font-size: 0.92rem; color: var(--color-text); }
        .session-body strong { color: var(--color-accent); }
        .session-notes { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0, 180, 216, 0.3); }
        .session-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .empty-state { margin: 0; padding: 18px; border-radius: 14px; background-color: rgba(144, 224, 239, 0.46); color: var(--color-navy); text-align: center; font-weight: 600; }
        .stats-panel { margin: 0 28px 28px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; }
        .stat-item { background-color: rgba(255, 255, 255, 0.9); border: 1px solid var(--color-border); border-radius: 16px; padding: 16px 18px; box-shadow: 0 12px 26px var(--shadow-soft); backdrop-filter: blur(4px); }
        .stat-value { display: block; font-size: 1.4rem; font-weight: 700; color: var(--color-accent); }
        .stat-label { color: var(--color-navy-light); font-size: 0.9rem; margin-top: 4px; display: block; }
        button { border: none; border-radius: 999px; padding: 10px 18px; cursor: pointer; font-weight: 600; font-size: 0.95rem; background-color: var(--color-accent); color: #fff; transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 10px 22px rgba(0, 119, 182, 0.26); }
        button:hover { background-color: var(--color-navy); box-shadow: 0 12px 28px rgba(3, 4, 94, 0.28); }
        button:active { transform: scale(0.98); }
        button.button-secondary { background-color: var(--color-beige); color: var(--color-navy); box-shadow: none; }
        button.button-secondary:hover { background-color: var(--color-cream); }
        button.button-outline { background-color: transparent; color: var(--color-accent); border: 1px solid var(--color-border); box-shadow: none; }
        button.button-outline:hover { background-color: var(--color-accent-soft); }
        button.button-danger { background-color: var(--color-danger); color: #fff; box-shadow: 0 10px 22px rgba(185, 28, 28, 0.22); }
        button.button-danger:hover { background-color: #991b1b; box-shadow: 0 12px 26px rgba(153, 27, 27, 0.24); }
        #back-button { background-color: var(--color-beige); color: var(--color-navy); box-shadow: none; }
        #back-button:hover { background-color: var(--color-cream); }
        .button-muted { background-color: #e5e7eb !important; color: #9aa0b4 !important; border-color: #d1d5db !important; box-shadow: none !important; }
        .button-muted:hover { background-color: #e5e7eb !important; }
        .card-footer { display: flex; justify-content: flex-end; padding: 0 28px 28px; }
        .footer-actions { display: flex; flex-direction: column; gap: 12px; align-items: flex-end; }
        #context-info { margin: 0 28px 12px; color: var(--color-navy-light); font-size: 0.95rem; }
        input[type="text"], input[type="email"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            border: 1px solid var(--color-border);
            border-radius: 10px;
            padding: 10px 12px;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--color-text);
            background-color: var(--color-cream);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45);
        }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--color-accent); outline-offset: 1px; background-color: #fff; }
        textarea { min-height: 96px; resize: vertical; }
        label.form-field { display: flex; flex-direction: column; gap: 6px; font-weight: 600; color: var(--color-text); font-size: 0.95rem; }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(3, 4, 94, 0.52); display: flex; align-items: center; justify-content: center; padding: 16px; z-index: 1000; }
        .modal-backdrop[hidden] { display: none; }
        .modal { background-color: var(--color-cream); border-radius: 16px; box-shadow: 0 20px 44px var(--shadow-strong); max-width: 420px; width: 100%; padding: 22px 24px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--color-border); }
        .modal h3 { margin: 0 0 12px; font-size: 1.2rem; color: var(--color-text); }
        .modal form { display: grid; gap: 10px; }
        .modal input,
        .modal select,
        .modal textarea { padding: 10px 12px; font-size: 0.92rem; border-radius: 10px; border: 1px solid var(--color-border); background-color: var(--color-cream); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4); }
        .modal input:focus,
        .modal select:focus,
        .modal textarea:focus { outline: 2px solid var(--color-accent); outline-offset: 1px; background-color: #fff; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 2px; }
        .modal-actions button { border-radius: 999px; padding: 10px 18px; font-weight: 600; font-size: 0.95rem; }
        @media (max-width: 860px) {
            .detail-grid { padding: 0 20px 24px; }
        }
        @media (max-width: 600px) {
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-actions { width: 100%; justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Expedientes Clínicos</h1>
    </header>
    <main>
        <section class="card" aria-live="polite">
            <div class="card-header">
                <div>
                    <h2 id="patient-name">Paciente</h2>
                    <p id="patient-service">Tipo de servicio</p>
                </div>
                <div class="card-actions">
                    <span id="patient-status" class="status-chip">Estado</span>
                    <button id="back-button" type="button">Volver a pacientes</button>
                    <button id="back-expediente-button" type="button" class="button-outline">Volver al expediente</button>
                </div>
            </div>
            <p id="context-info" hidden></p>
            <div id="status-banner" class="status-banner"></div>
            <div class="detail-grid">
                <section class="panel sessions-panel" aria-labelledby="sessions-title">
                    <div class="panel-header">
                        <h3 id="sessions-title">Sesiones registradas</h3>
                        <div class="panel-actions-inline">
                            <button id="refresh-button" type="button" class="button-secondary">Actualizar</button>
                            <button id="add-session-button" type="button" class="button-outline">Añadir</button>
                            <button id="print-session-button" type="button" class="button-outline">Imprimir</button>
                        </div>
                    </div>
                    <ul id="sessions-list" class="session-grid"></ul>
                    <p id="sessions-empty" class="empty-state" hidden>No hay sesiones registradas.</p>
                </section>
            </div>
            <section class="panel stats-panel" aria-labelledby="stats-title">
                <h3 id="stats-title">Asistencias</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span id="stat-total" class="stat-value">0</span>
                        <span class="stat-label">Sesiones totales</span>
                    </div>
                    <div class="stat-item">
                        <span id="stat-completadas" class="stat-value">0</span>
                        <span class="stat-label">Sesiones asistidas</span>
                    </div>
                    <div class="stat-item">
                        <span id="stat-canceladas" class="stat-value">0</span>
                        <span class="stat-label">Sesiones canceladas</span>
                    </div>
                    <div class="stat-item">
                        <span id="stat-faltas" class="stat-value">0</span>
                        <span class="stat-label">Faltas registradas</span>
                    </div>
                </div>
            </section>
            
        </section>
    </main>

    

    <div id="session-modal-backdrop" class="modal-backdrop" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="session-modal-title">
            <h3 id="session-modal-title">Registrar sesión</h3>
            <form id="session-form">
                <label class="form-field" for="session-numero">
                    Número de sesión
                    <input id="session-numero" name="numeroSesion" type="number" min="1" required>
                </label>
                <label class="form-field" for="session-fecha">
                    Fecha
                    <input id="session-fecha" name="fecha" type="date" required>
                </label>
                <label class="form-field" for="session-tipo">
                    Tipo de sesión
                    <select id="session-tipo" name="tipoSesion" required></select>
                </label>
                <label class="form-field" for="session-asistencia">
                    Estado de asistencia
                    <select id="session-asistencia" name="asistencia" required></select>
                </label>
                <label class="form-field" for="session-duracion">
                    Duración (minutos)
                    <input id="session-duracion" name="duracionMinutos" type="number" min="0" placeholder="Ej. 60">
                </label>
                <label class="form-field" for="session-motivo">
                    Motivo de cancelación
                    <input id="session-motivo" name="motivoCancelacion" type="text" placeholder="Especifica solo si aplica">
                </label>
                <label class="form-field" for="session-descripcion">
                    Descripción
                    <textarea id="session-descripcion" name="descripcion" required></textarea>
                </label>
                <label class="form-field" for="session-observaciones">
                    Observaciones
                    <textarea id="session-observaciones" name="observaciones"></textarea>
                </label>
                <div class="modal-actions">
                    <button id="session-cancel-button" type="button" class="button-secondary">Cancelar</button>
                    <button id="session-submit-button" type="submit">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="print-modal-backdrop" class="modal-backdrop" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="print-modal-title">
            <h3 id="print-modal-title">Imprimir sesión</h3>
            <form id="print-form">
                <label class="form-field" for="print-session-select">
                    Selecciona la sesión
                    <select id="print-session-select" required></select>
                </label>
                <div class="modal-actions">
                    <button id="print-cancel-button" type="button" class="button-secondary">Cancelar</button>
                    <button id="print-submit-button" type="submit">Aceptar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function () {
            const DEFAULT_API_URL = "https://expedientesclinicos.onrender.com";
            const API_BASE_KEY = 'expedientesclinicos.apiBaseUrl';
            const USER_ID_KEY = 'expedientesclinicos.usuarioId';
            const ROLE_KEY = 'expedientesclinicos.role';
            const LEGACY_THERAPIST_KEY = 'expedientesclinicos.therapistId';

            const patientName = document.getElementById('patient-name');
            const patientService = document.getElementById('patient-service');
            const patientStatus = document.getElementById('patient-status');
            const contextInfo = document.getElementById('context-info');
            const statusBanner = document.getElementById('status-banner');
            const sessionsList = document.getElementById('sessions-list');
            const sessionsEmpty = document.getElementById('sessions-empty');
            const statFields = {
                total: document.getElementById('stat-total'),
                completadas: document.getElementById('stat-completadas'),
                canceladas: document.getElementById('stat-canceladas'),
                faltas: document.getElementById('stat-faltas')
            };
            const refreshButton = document.getElementById('refresh-button');
            const addSessionButton = document.getElementById('add-session-button');
            const printSessionButton = document.getElementById('print-session-button');
            const backButton = document.getElementById('back-button');
            const backExpedienteButton = document.getElementById('back-expediente-button');
            

            const sessionModalBackdrop = document.getElementById('session-modal-backdrop');
            const sessionForm = document.getElementById('session-form');
            const sessionModalTitle = document.getElementById('session-modal-title');
            const sessionCancelButton = document.getElementById('session-cancel-button');
            const sessionSubmitButton = document.getElementById('session-submit-button');
            const sessionNumeroInput = document.getElementById('session-numero');
            const sessionFechaInput = document.getElementById('session-fecha');
            const sessionTipoSelect = document.getElementById('session-tipo');
            const sessionAsistenciaSelect = document.getElementById('session-asistencia');
            const sessionDuracionInput = document.getElementById('session-duracion');
            const sessionMotivoInput = document.getElementById('session-motivo');
            const sessionDescripcionInput = document.getElementById('session-descripcion');
            const sessionObservacionesInput = document.getElementById('session-observaciones');

            const printModalBackdrop = document.getElementById('print-modal-backdrop');
            const printForm = document.getElementById('print-form');
            const printSessionSelect = document.getElementById('print-session-select');
            const printCancelButton = document.getElementById('print-cancel-button');
            const printSubmitButton = document.getElementById('print-submit-button');

            let currentPatient = null;
            let editingSession = null;
            let currentSessions = [];
            

            const SERVICE_OPTIONS = [
                { value: 'TERAPIA_INDIVIDUAL', label: 'Psicoterapia' },
                { value: 'TERAPIA_FAMILIAR', label: 'Terapia familiar' },
                { value: 'TERAPIA_PAREJA', label: 'Terapia de pareja' },
                { value: 'TERAPIA_GRUPAL', label: 'Terapia grupal' },
                { value: 'EVALUACION_PSICOLOGICA', label: 'Psicodiagnóstico' },
                { value: 'INTERVENCION_CRISIS', label: 'Intervención en crisis' }
            ];

            const SESSION_TYPE_OPTIONS = [
                { value: 'INDIVIDUAL', label: 'Sesión individual' },
                { value: 'FAMILIAR', label: 'Sesión familiar' },
                { value: 'GRUPAL', label: 'Sesión grupal' },
                { value: 'EVALUACION_INICIAL', label: 'Evaluación inicial' },
                { value: 'SEGUIMIENTO', label: 'Sesión de seguimiento' },
                { value: 'CRISIS', label: 'Atención en crisis' },
                { value: 'PSICOEDUCATIVA', label: 'Sesión psicoeducativa' }
            ];

            const ATTENDANCE_OPTIONS = [
                { value: 'ASISTIO', label: 'Asistió' },
                { value: 'CANCELADA', label: 'Cancelada' },
                { value: 'FALTA', label: 'Falta' }
            ];

            const SERVICE_LABELS = SERVICE_OPTIONS.reduce(function (acc, option) {
                acc[option.value] = option.label;
                return acc;
            }, {});

            const SESSION_TYPE_LABELS = SESSION_TYPE_OPTIONS.reduce(function (acc, option) {
                acc[option.value] = option.label;
                return acc;
            }, {});

            

            const populateSelect = function (select, options) {
                select.innerHTML = '';
                options.forEach(function (option) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.label;
                    select.appendChild(opt);
                });
            };

            populateSelect(sessionTipoSelect, SESSION_TYPE_OPTIONS);
            populateSelect(sessionAsistenciaSelect, ATTENDANCE_OPTIONS);

            const params = new URLSearchParams(window.location.search);
            const patientParam = params.get('pacienteId');
            const patientId = patientParam ? Number(patientParam) : NaN;
            const therapistOriginParam = params.get('terapeutaId');
            const therapistOriginId = therapistOriginParam ? Number(therapistOriginParam) : NaN;

            const role = sessionStorage.getItem(ROLE_KEY);
            const isTherapist = role === 'TERAPEUTA';
            const isAdmin = role === 'ADMINISTRADOR';
            if (!isTherapist && !isAdmin) {
                window.location.href = 'index.html';
                return;
            }

            let therapistIdRaw = sessionStorage.getItem(USER_ID_KEY);
            if (!therapistIdRaw && isTherapist) {
                const legacyId = sessionStorage.getItem(LEGACY_THERAPIST_KEY);
                if (legacyId) {
                    therapistIdRaw = legacyId;
                    sessionStorage.setItem(USER_ID_KEY, legacyId);
                }
            }

            if (!therapistIdRaw) {
                window.location.href = 'index.html';
                return;
            }

            const viewerId = Number(therapistIdRaw);
            if (Number.isNaN(viewerId)) {
                statusBanner.textContent = 'El identificador almacenado no es válido. Inicia sesión nuevamente.';
                statusBanner.classList.add('error');
                sessionStorage.removeItem(USER_ID_KEY);
                sessionStorage.removeItem(ROLE_KEY);
                sessionStorage.removeItem(LEGACY_THERAPIST_KEY);
                return;
            }

            const perfil = isAdmin ? 'ADMINISTRADOR' : 'TERAPEUTA';
            const therapistId = viewerId;

            if (Number.isNaN(patientId)) {
                statusBanner.textContent = 'Selecciona un paciente desde la lista de pacientes para ver sus sesiones.';
                statusBanner.classList.add('error');
                refreshButton.disabled = true;
                return;
            }

            const apiBaseUrl = sessionStorage.getItem(API_BASE_KEY) || DEFAULT_API_URL;
            if (contextInfo) {
                contextInfo.textContent = '';
                contextInfo.hidden = !isAdmin;
            }

            if (isAdmin) {
                if (addSessionButton) {
                    addSessionButton.hidden = true;
                    addSessionButton.disabled = true;
                }
                if (sessionSubmitButton) {
                    sessionSubmitButton.disabled = true;
                }
            }

            const formatService = function (service) {
                if (!service) return 'Sin tipo';
                return SERVICE_LABELS[service] || service.replace(/_/g, ' ').toLowerCase();
            };

            const formatPatientStatus = function (status) {
                if (!status) return { text: 'Sin estado', className: '' };
                const mapping = {
                    ACTIVO: { text: 'Activo', className: 'estado-activo' },
                    EN_ESPERA: { text: 'En espera', className: 'estado-en-espera' },
                    ARCHIVADO: { text: 'Archivado', className: 'estado-archivado' }
                };
                return mapping[status] || { text: status, className: '' };
            };

            const formatSessionType = function (type) {
                if (!type) return 'Sin tipo';
                return SESSION_TYPE_LABELS[type] || type.replace(/_/g, ' ').toLowerCase();
            };

            const formatAttendance = function (state) {
                if (!state) return { text: 'Sin registro', className: '' };
                const mapping = {
                    ASISTIO: { text: 'Asistió', className: 'asistio' },
                    CANCELADA: { text: 'Cancelada', className: 'cancelada' },
                    FALTA: { text: 'Falta', className: 'falta' }
                };
                return mapping[state] || { text: state, className: '' };
            };

            const formatDate = function (value) {
                if (!value) return '--';
                try {
                    const date = new Date(value + 'T00:00:00');
                    return new Intl.DateTimeFormat('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(date);
                } catch (error) {
                    return value;
                }
            };

            const createInfoRow = function (label, value, extraClass) {
                const p = document.createElement('p');
                if (extraClass) {
                    p.classList.add(extraClass);
                }
                const strong = document.createElement('strong');
                strong.textContent = label;
                p.appendChild(strong);
                p.appendChild(document.createTextNode(' ' + value));
                return p;
            };

            

            const computeNextSessionNumber = function () {
                if (!currentSessions.length) {
                    return 1;
                }
                return currentSessions.reduce(function (max, session) {
                    const numero = typeof session.numeroSesion === 'number' ? session.numeroSesion : 0;
                    return numero > max ? numero : max;
                }, 0) + 1;
            };

            const resetSessionForm = function () {
                sessionForm.reset();
                sessionMotivoInput.value = '';
                sessionObservacionesInput.value = '';
            };

            const fillSessionForm = function (session) {
                if (session) {
                    sessionNumeroInput.value = session.numeroSesion !== null && session.numeroSesion !== undefined ? session.numeroSesion : '';
                    sessionFechaInput.value = session.fecha || '';
                    sessionTipoSelect.value = session.tipoSesion || SESSION_TYPE_OPTIONS[0].value;
                    sessionAsistenciaSelect.value = session.asistencia || ATTENDANCE_OPTIONS[0].value;
                    sessionDuracionInput.value = session.duracionMinutos !== null && session.duracionMinutos !== undefined ? session.duracionMinutos : '';
                    sessionMotivoInput.value = session.motivoCancelacion || '';
                    sessionDescripcionInput.value = session.descripcion || '';
                    sessionObservacionesInput.value = session.observaciones || '';
                } else {
                    resetSessionForm();
                    sessionNumeroInput.value = computeNextSessionNumber();
                    const today = new Date().toISOString().slice(0, 10);
                    sessionFechaInput.value = today;
                    sessionTipoSelect.value = SESSION_TYPE_OPTIONS[0].value;
                    sessionAsistenciaSelect.value = ATTENDANCE_OPTIONS[0].value;
                }
            };

            const openSessionModal = function (mode, session) {
                if (isAdmin) {
                    statusBanner.textContent = 'Los administradores solo pueden consultar las sesiones registradas.';
                    statusBanner.classList.remove('error');
                    return;
                }
                if (currentPatient && currentPatient.estado === 'ARCHIVADO') {
                    statusBanner.textContent = 'El paciente está archivado; reactívalo para registrar o editar sesiones.';
                    statusBanner.classList.remove('error');
                    return;
                }
                editingSession = mode === 'edit' ? session : null;
                sessionModalTitle.textContent = mode === 'edit' ? 'Editar sesion' : 'Registrar sesion';
                sessionSubmitButton.textContent = mode === 'edit' ? 'Guardar cambios' : 'Registrar';
                fillSessionForm(editingSession);
                sessionModalBackdrop.hidden = false;
                sessionSubmitButton.disabled = false;
                setTimeout(function () {
                    sessionNumeroInput.focus();
                }, 0);
            };

            const closeSessionModal = function () {
                sessionModalBackdrop.hidden = true;
                sessionSubmitButton.disabled = isAdmin;
                editingSession = null;
                resetSessionForm();
            };

            const buildSessionPayload = function () {
                if (isAdmin) {
                    throw new Error('Los administradores no pueden registrar o editar sesiones.');
                }
                if (currentPatient && currentPatient.estado === 'ARCHIVADO') {
                    throw new Error('El paciente está archivado; reactívalo para registrar sesiones.');
                }
                const numeroSesion = Number(sessionNumeroInput.value);
                if (!numeroSesion || Number.isNaN(numeroSesion) || numeroSesion < 1) {
                    throw new Error('El número de sesión debe ser mayor o igual a 1.');
                }
                const fecha = sessionFechaInput.value;
                if (!fecha) {
                    throw new Error('La fecha de la sesion es obligatoria.');
                }
                const tipoSesion = sessionTipoSelect.value;
                const asistencia = sessionAsistenciaSelect.value;
                const descripcion = sessionDescripcionInput.value.trim();
                if (!descripcion) {
                    throw new Error('La descripcion de la sesion es obligatoria.');
                }
                let duracion = sessionDuracionInput.value === '' ? null : Number(sessionDuracionInput.value);
                if (duracion !== null && Number.isNaN(duracion)) {
                    throw new Error('La duración debe ser un número válido.');
                }
                const motivo = sessionMotivoInput.value.trim();
                const observaciones = sessionObservacionesInput.value.trim();

                return {
                    solicitante: { usuarioId: therapistId, perfil: perfil },
                    terapeutaId: therapistId,
                    numeroSesion: numeroSesion,
                    tipoSesion: tipoSesion,
                    fecha: fecha,
                    asistencia: asistencia,
                    duracionMinutos: duracion,
                    motivoCancelacion: motivo.length ? motivo : null,
                    descripcion: descripcion,
                    observaciones: observaciones.length ? observaciones : null
                };
            };

            const submitSessionForm = async function (event) {
                event.preventDefault();
                try {
                    if (isAdmin) {
                        statusBanner.textContent = 'Los administradores no pueden registrar ni editar sesiones.';
                        statusBanner.classList.remove('error');
                        return;
                    }
                    const payload = buildSessionPayload();
                    sessionSubmitButton.disabled = true;
                    const baseUrl = apiBaseUrl + '/api/pacientes/' + encodeURIComponent(patientId) + '/sesiones';
                    const isEdit = Boolean(editingSession && editingSession.id);
                    const url = isEdit ? baseUrl + '/' + encodeURIComponent(editingSession.id) : baseUrl;
                    const method = isEdit ? 'PUT' : 'POST';
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error('Error ' + response.status + ' al ' + (isEdit ? 'actualizar' : 'registrar') + ' la sesion.');
                    }
                    closeSessionModal();
                    const success = await loadData();
                    if (success) {
                        statusBanner.textContent = isEdit ? 'Sesion actualizada correctamente.' : 'Sesion registrada correctamente.';
                        statusBanner.classList.remove('error');
                    }
                } catch (error) {
                    sessionSubmitButton.disabled = false;
                    statusBanner.textContent = error.message || 'No fue posible guardar la sesion.';
                    statusBanner.classList.add('error');
                }
            };

            const imprimirSesion = async function (session) {
                if (!session || !session.id) {
                    statusBanner.textContent = 'No se pudo encontrar la sesion seleccionada.';
                    statusBanner.classList.add('error');
                    return;
                }
                try {
                    statusBanner.textContent = 'Generando PDF de la sesion...';
                    statusBanner.classList.remove('error');
                    const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(patientId) + '/sesiones/' + encodeURIComponent(session.id) + '/pdf');
                    url.searchParams.set('usuarioId', therapistId);
                    url.searchParams.set('perfil', perfil);
                    const response = await fetch(url.toString());
                    if (!response.ok) {
                        throw new Error('Error ' + response.status + ' al generar el PDF de la sesion.');
                    }
                    const blob = await response.blob();
                    const pdfUrl = URL.createObjectURL(blob);
                    window.open(pdfUrl, '_blank');
                    setTimeout(function () {
                        URL.revokeObjectURL(pdfUrl);
                    }, 120000);
                    statusBanner.textContent = 'PDF generado en una nueva pestaña.';
                    statusBanner.classList.remove('error');
                } catch (error) {
                    statusBanner.textContent = error.message || 'No fue posible generar el PDF de la sesion.';
                    statusBanner.classList.add('error');
                }
            };

            const renderPatient = function (patient) {
                currentPatient = patient;
                patientName.textContent = patient.nombreCompleto || 'Paciente sin nombre';
                const serviceText = formatService(patient.tipoServicio);
                patientService.textContent = serviceText;
                const statusInfo = formatPatientStatus(patient.estado);
                patientStatus.textContent = statusInfo.text;
                patientStatus.className = 'status-chip ' + statusInfo.className;
                if (!isAdmin && addSessionButton) {
                    const archived = patient.estado === 'ARCHIVADO';
                    addSessionButton.hidden = archived;
                    addSessionButton.disabled = archived;
                }

            };

            const renderSessions = function (sessions) {
                currentSessions = Array.isArray(sessions) ? sessions.slice() : [];
                sessionsList.innerHTML = '';
                if (!sessions || !sessions.length) {
                    sessionsEmpty.hidden = false;
                    return;
                }
                sessionsEmpty.hidden = true;
                const fragment = document.createDocumentFragment();
                sessions.sort(function (a, b) {
                    return (a.numeroSesion || 0) - (b.numeroSesion || 0);
                });
                sessions.forEach(function (session) {
                    const li = document.createElement('li');
                    li.className = 'session-card';

                    const header = document.createElement('div');
                    header.className = 'session-header';

                    const number = document.createElement('span');
                    number.className = 'session-number';
                    const numero = session.numeroSesion !== null && session.numeroSesion !== undefined ? session.numeroSesion : '?';
                    number.textContent = 'Sesión ' + numero;

                    const statusInfo = formatAttendance(session.asistencia);
                    const status = document.createElement('span');
                    status.className = 'session-status ' + statusInfo.className;
                    status.textContent = statusInfo.text;

                    header.appendChild(number);
                    header.appendChild(status);

                    const body = document.createElement('div');
                    body.className = 'session-body';

                    const durationText = session.duracionMinutos ? session.duracionMinutos + ' min' : 'No registrado';
                    const description = session.descripcion ? session.descripcion : 'Sin descripcion.';

                    body.appendChild(createInfoRow('Fecha:', formatDate(session.fecha)));
                    body.appendChild(createInfoRow('Tipo:', formatSessionType(session.tipoSesion)));
                    body.appendChild(createInfoRow('Duración:', durationText));

                    if (session.motivoCancelacion) {
                        body.appendChild(createInfoRow('Motivo de cancelación:', session.motivoCancelacion));
                    }

                    if (session.observaciones) {
                        body.appendChild(createInfoRow('Observaciones:', session.observaciones));
                    }

                    body.appendChild(createInfoRow('Notas:', description, 'session-notes'));

                    li.appendChild(header);
                    li.appendChild(body);
                    if (!isAdmin && currentPatient && currentPatient.estado !== 'ARCHIVADO') {
                        const actions = document.createElement('div');
                        actions.className = 'session-actions';

                        const editButton = document.createElement('button');
                        editButton.type = 'button';
                        editButton.className = 'button-outline';
                        editButton.textContent = 'Editar';
                        editButton.addEventListener('click', function (event) {
                            event.stopPropagation();
                            openSessionModal('edit', session);
                        });

                        actions.appendChild(editButton);
                        li.appendChild(actions);
                    }
                    fragment.appendChild(li);
                });
                sessionsList.appendChild(fragment);
            };
            const openPrintModal = function () {
                printSessionSelect.innerHTML = '';
                if (!currentSessions || currentSessions.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No hay sesiones para imprimir';
                    printSessionSelect.appendChild(opt);
                    printSubmitButton.disabled = true;
                } else {
                    const sorted = currentSessions.slice().sort(function (a, b) {
                        return (a.numeroSesion || 0) - (b.numeroSesion || 0);
                    });
                    sorted.forEach(function (s) {
                        const opt = document.createElement('option');
                        opt.value = String(s.id);
                        const numero = s.numeroSesion !== null && s.numeroSesion !== undefined ? s.numeroSesion : '?';
                        const fechaTxt = s.fecha ? (' - ' + formatDate(s.fecha)) : '';
                        opt.textContent = 'Sesión ' + numero + fechaTxt;
                        printSessionSelect.appendChild(opt);
                    });
                    printSubmitButton.disabled = false;
                }
                printModalBackdrop.hidden = false;
                setTimeout(function () { printSessionSelect.focus(); }, 0);
            };

            const closePrintModal = function () {
                printModalBackdrop.hidden = true;
                printSubmitButton.disabled = false;
            };

            const submitPrintForm = function (event) {
                event.preventDefault();
                const selectedId = printSessionSelect.value;
                if (!selectedId) {
                    return;
                }
                const session = currentSessions.find(function (s) { return String(s.id) === selectedId; });
                closePrintModal();
                if (session) {
                    imprimirSesion(session);
                } else {
                    statusBanner.textContent = 'No se encontró la sesión seleccionada.';
                    statusBanner.classList.add('error');
                }
            };

            const renderStats = function (sessions) {
                const total = sessions.length;
                const completadas = sessions.filter(function (s) { return s.asistencia === 'ASISTIO'; }).length;
                const canceladas = sessions.filter(function (s) { return s.asistencia === 'CANCELADA'; }).length;
                const faltas = sessions.filter(function (s) { return s.asistencia === 'FALTA'; }).length;

                statFields.total.textContent = total;
                statFields.completadas.textContent = completadas;
                statFields.canceladas.textContent = canceladas;
                statFields.faltas.textContent = faltas;
            };

            const fetchPatient = async function () {
                const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(patientId));
                url.searchParams.set('usuarioId', therapistId);
                url.searchParams.set('perfil', perfil);
                const response = await fetch(url.toString());
                if (!response.ok) {
                    throw new Error('Error ' + response.status + ' al obtener el paciente.');
                }
                return response.json();
            };

            const fetchSessions = async function () {
                const url = new URL(apiBaseUrl + '/api/pacientes/' + encodeURIComponent(patientId) + '/sesiones');
                url.searchParams.set('usuarioId', therapistId);
                url.searchParams.set('perfil', perfil);
                const response = await fetch(url.toString());
                if (!response.ok) {
                    throw new Error('Error ' + response.status + ' al obtener las sesiones.');
                }
                return response.json();
            };

            const loadData = async function () {
                statusBanner.textContent = 'Cargando informacion...';
                statusBanner.classList.remove('error');
                try {
                    const [patient, sessions] = await Promise.all([fetchPatient(), fetchSessions()]);
                    renderPatient(patient);
                    const list = Array.isArray(sessions) ? sessions : [];
                    renderSessions(list);
                    renderStats(list);
                    const timeStamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    statusBanner.textContent = 'Datos actualizados (' + timeStamp + ').';
                    statusBanner.classList.remove('error');
                    return true;
                } catch (error) {
                    statusBanner.textContent = error.message;
                    statusBanner.classList.add('error');
                    renderSessions([]);
                    renderStats([]);
                    return false;
                }
            };

            

            addSessionButton.addEventListener('click', function () {
                openSessionModal('create');
            });


            printSessionButton.addEventListener('click', function () {
                openPrintModal();
            });



            sessionCancelButton.addEventListener('click', function () {
                closeSessionModal();
            });

            sessionForm.addEventListener('submit', submitSessionForm);

            printCancelButton.addEventListener('click', function () {
                closePrintModal();
            });
            printForm.addEventListener('submit', submitPrintForm);

            sessionModalBackdrop.addEventListener('click', function (event) {
                if (event.target === sessionModalBackdrop) {
                    closeSessionModal();
                }
            });

            printModalBackdrop.addEventListener('click', function (event) {
                if (event.target === printModalBackdrop) {
                    closePrintModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    if (!sessionModalBackdrop.hidden) {
                        closeSessionModal();
                    }
                    if (!printModalBackdrop.hidden) {
                        closePrintModal();
                    }
                }
            });

            refreshButton.addEventListener('click', function () { loadData(); });
            backButton.addEventListener('click', function () {
                if (isAdmin) {
                    if (!Number.isNaN(therapistOriginId)) {
                        window.location.href = 'terapeuta.html?terapeutaId=' + encodeURIComponent(therapistOriginId);
                        return;
                    }
                    window.location.href = 'panel_admin.html?view=patients';
                    return;
                }
                window.location.href = 'pacientes.html';
            });
            backExpedienteButton.addEventListener('click', function () {
                if (!Number.isNaN(patientId)) {
                    let target = 'expediente.html?pacienteId=' + encodeURIComponent(patientId);
                    if (isAdmin && !Number.isNaN(therapistOriginId)) {
                        target += '&terapeutaId=' + encodeURIComponent(therapistOriginId);
                    }
                    window.location.href = target;
                }
            });

            loadData();
        })();
    </script>
</body>
</html>