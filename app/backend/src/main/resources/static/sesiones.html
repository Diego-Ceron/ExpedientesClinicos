<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sesiones clinicas - Expedientes Clinicos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; }
        main { max-width: 1100px; }
        header { margin-bottom: 24px; }
        nav a { margin-right: 12px; }
        form { border: 1px solid #ccc; padding: 16px; margin-bottom: 24px; border-radius: 6px; }
        fieldset { margin-bottom: 16px; }
        legend { font-weight: bold; }
        label { display: block; margin-bottom: 8px; }
        input, select, textarea { width: 100%; max-width: 420px; padding: 6px; margin-top: 4px; }
        textarea { min-height: 80px; }
        .response { background-color: #111; color: #f5f5f5; padding: 12px; margin-top: 12px; border-radius: 4px; white-space: pre-wrap; overflow-x: auto; min-height: 48px; }
        .actions { margin-top: 12px; }
    </style>
</head>
<body>
    <main>
        <header>
            <h1>Gestion de sesiones clinicas</h1>
            <p>Formularios base para administrar las sesiones de cada paciente.</p>
            <nav>
                <a href="index.html">Inicio</a>
                <a href="pacientes.html">Pacientes</a>
                <a href="terapeutas.html">Terapeutas</a>
            </nav>
        </header>

        <section>
            <h2>Registrar sesion</h2>
            <form data-endpoint="/api/pacientes/{pacienteId}/sesiones" data-method="POST">
                <label>ID del paciente
                    <input type="number" data-path="pacienteId" required>
                </label>
                <fieldset>
                    <legend>Solicitante</legend>
                    <label>Usuario ID
                        <input type="number" name="solicitante.usuarioId" data-type="number" required>
                    </label>
                    <label>Perfil
                        <select name="solicitante.perfil" required>
                            <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                            <option value="TERAPEUTA">TERAPEUTA</option>
                        </select>
                    </label>
                </fieldset>
                <fieldset>
                    <legend>Datos de la sesion</legend>
                    <label>Terapeuta ID
                        <input type="number" name="terapeutaId" data-type="number" required>
                    </label>
                    <label>Numero de sesion
                        <input type="number" name="numeroSesion" data-type="number" required>
                    </label>
                    <label>Tipo de sesion
                        <select name="tipoSesion" required>
                            <option value="INDIVIDUAL">INDIVIDUAL</option>
                            <option value="FAMILIAR">FAMILIAR</option>
                            <option value="GRUPAL">GRUPAL</option>
                            <option value="EVALUACION_INICIAL">EVALUACION_INICIAL</option>
                            <option value="SEGUIMIENTO">SEGUIMIENTO</option>
                            <option value="CRISIS">CRISIS</option>
                            <option value="PSICOEDUCATIVA">PSICOEDUCATIVA</option>
                        </select>
                    </label>
                    <label>Fecha
                        <input type="date" name="fecha" required>
                    </label>
                    <label>Estado de asistencia
                        <select name="asistencia" required>
                            <option value="ASISTIO">ASISTIO</option>
                            <option value="CANCELADA">CANCELADA</option>
                            <option value="FALTA">FALTA</option>
                        </select>
                    </label>
                    <label>Duracion en minutos
                        <input type="number" name="duracionMinutos" data-type="number" min="0">
                    </label>
                    <label>Motivo de cancelacion (solo si aplica)
                        <textarea name="motivoCancelacion"></textarea>
                    </label>
                    <label>Descripcion
                        <textarea name="descripcion" required></textarea>
                    </label>
                    <label>Observaciones
                        <textarea name="observaciones"></textarea>
                    </label>
                </fieldset>
                <div class="actions">
                    <button type="submit">Registrar</button>
                    <button type="reset">Limpiar</button>
                </div>
                <pre class="response"></pre>
            </form>
        </section>

        <section>
            <h2>Actualizar sesion</h2>
            <form data-endpoint="/api/pacientes/{pacienteId}/sesiones/{sesionId}" data-method="PUT">
                <label>ID del paciente
                    <input type="number" data-path="pacienteId" required>
                </label>
                <label>ID de la sesion
                    <input type="number" data-path="sesionId" required>
                </label>
                <fieldset>
                    <legend>Solicitante</legend>
                    <label>Usuario ID
                        <input type="number" name="solicitante.usuarioId" data-type="number" required>
                    </label>
                    <label>Perfil
                        <select name="solicitante.perfil" required>
                            <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                            <option value="TERAPEUTA">TERAPEUTA</option>
                        </select>
                    </label>
                </fieldset>
                <fieldset>
                    <legend>Datos de la sesion</legend>
                    <label>Terapeuta ID
                        <input type="number" name="terapeutaId" data-type="number" required>
                    </label>
                    <label>Numero de sesion
                        <input type="number" name="numeroSesion" data-type="number" required>
                    </label>
                    <label>Tipo de sesion
                        <select name="tipoSesion" required>
                            <option value="INDIVIDUAL">INDIVIDUAL</option>
                            <option value="FAMILIAR">FAMILIAR</option>
                            <option value="GRUPAL">GRUPAL</option>
                            <option value="EVALUACION_INICIAL">EVALUACION_INICIAL</option>
                            <option value="SEGUIMIENTO">SEGUIMIENTO</option>
                            <option value="CRISIS">CRISIS</option>
                            <option value="PSICOEDUCATIVA">PSICOEDUCATIVA</option>
                        </select>
                    </label>
                    <label>Fecha
                        <input type="date" name="fecha" required>
                    </label>
                    <label>Estado de asistencia
                        <select name="asistencia" required>
                            <option value="ASISTIO">ASISTIO</option>
                            <option value="CANCELADA">CANCELADA</option>
                            <option value="FALTA">FALTA</option>
                        </select>
                    </label>
                    <label>Duracion en minutos
                        <input type="number" name="duracionMinutos" data-type="number" min="0">
                    </label>
                    <label>Motivo de cancelacion
                        <textarea name="motivoCancelacion"></textarea>
                    </label>
                    <label>Descripcion
                        <textarea name="descripcion" required></textarea>
                    </label>
                    <label>Observaciones
                        <textarea name="observaciones"></textarea>
                    </label>
                </fieldset>
                <div class="actions">
                    <button type="submit">Actualizar</button>
                </div>
                <pre class="response"></pre>
            </form>
        </section>

        <section>
            <h2>Listar sesiones por paciente</h2>
            <form data-endpoint="/api/pacientes/{pacienteId}/sesiones" data-method="GET">
                <label>ID del paciente
                    <input type="number" data-path="pacienteId" required>
                </label>
                <label>Usuario solicitante ID
                    <input type="number" data-query="usuarioId" required>
                </label>
                <label>Perfil solicitante
                    <select data-query="perfil" required>
                        <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                        <option value="TERAPEUTA">TERAPEUTA</option>
                    </select>
                </label>
                <div class="actions">
                    <button type="submit">Listar</button>
                </div>
                <pre class="response"></pre>
            </form>
        </section>

        <section>
            <h2>Historial de una sesion</h2>
            <form data-endpoint="/api/pacientes/{pacienteId}/sesiones/{sesionId}/history" data-method="GET">
                <label>ID del paciente
                    <input type="number" data-path="pacienteId" required>
                </label>
                <label>ID de la sesion
                    <input type="number" data-path="sesionId" required>
                </label>
                <label>Usuario solicitante ID
                    <input type="number" data-query="usuarioId" required>
                </label>
                <label>Perfil solicitante
                    <select data-query="perfil" required>
                        <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                        <option value="TERAPEUTA">TERAPEUTA</option>
                    </select>
                </label>
                <div class="actions">
                    <button type="submit">Consultar</button>
                </div>
                <pre class="response"></pre>
            </form>
        </section>

        <section>
            <h2>Revertir sesion</h2>
            <form data-endpoint="/api/pacientes/{pacienteId}/sesiones/{sesionId}/revert" data-method="POST">
                <label>ID del paciente
                    <input type="number" data-path="pacienteId" required>
                </label>
                <label>ID de la sesion
                    <input type="number" data-path="sesionId" required>
                </label>
                <label>ID del historial a restaurar
                    <input type="number" name="historyId" data-type="number" required>
                </label>
                <fieldset>
                    <legend>Solicitante</legend>
                    <label>Usuario ID
                        <input type="number" name="solicitante.usuarioId" data-type="number" required>
                    </label>
                    <label>Perfil
                        <select name="solicitante.perfil" required>
                            <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                            <option value="TERAPEUTA">TERAPEUTA</option>
                        </select>
                    </label>
                </fieldset>
                <div class="actions">
                    <button type="submit">Revertir</button>
                </div>
                <pre class="response"></pre>
            </form>
        </section>

        <section>
            <h2>Generar PDF de la sesion</h2>
            <form data-endpoint="/api/pacientes/{pacienteId}/sesiones/{sesionId}/pdf" data-method="GET" data-expect="pdf">
                <label>ID del paciente
                    <input type="number" data-path="pacienteId" required>
                </label>
                <label>ID de la sesion
                    <input type="number" data-path="sesionId" required>
                </label>
                <label>Usuario solicitante ID
                    <input type="number" data-query="usuarioId" required>
                </label>
                <label>Perfil solicitante
                    <select data-query="perfil" required>
                        <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                        <option value="TERAPEUTA">TERAPEUTA</option>
                    </select>
                </label>
                <div class="actions">
                    <button type="submit">Generar PDF</button>
                </div>
                <pre class="response"></pre>
            </form>
        </section>
    </main>

    <script>
        (function () {
            
            const API_BASE = "https://expedientesclinicos.onrender.com";

            const forms = document.querySelectorAll('form[data-endpoint]');
            forms.forEach(function (form) {
                form.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const output = form.querySelector('.response');
                    if (output) output.textContent = 'Enviando...';

                    const method = form.dataset.method || 'GET';
                    let endpoint = form.dataset.endpoint;

                    form.querySelectorAll('[data-path]').forEach(input => {
                        endpoint = endpoint.replace(
                            `{${input.dataset.path}}`,
                            encodeURIComponent(input.value.trim())
                        );
                    });

                    if (/\{.+\}/.test(endpoint)) {
                        if (output) output.textContent = 'Faltan valores para completar la URL.';
                        return;
                    }

        
                    const queryParams = new URLSearchParams();
                    form.querySelectorAll('[data-query]').forEach(input => {
                        const v = input.value.trim();
                        if (v !== '') queryParams.append(input.dataset.query, v);
                    });

                    let url = API_BASE + endpoint;
                    const qs = queryParams.toString();
                    if (qs) url += (url.includes('?') ? '&' : '?') + qs;

                    let body = null;
                    if (method !== 'GET') body = buildBody(form);

                    const init = {
                        method,
                        headers: method === 'GET' ? {} : { 'Content-Type': 'application/json' },
                        body: method === 'GET' ? null : JSON.stringify(body || {})
                    };

                    try {
                        const response = await fetch(url, init);

                        if (!response.ok) {
                            const errorText = await response.text();
                            output.textContent = `Error ${response.status}: ${errorText}`;
                            return;
                        }

                        
                        if (form.dataset.expect === 'pdf') {
                            const blob = await response.blob();
                            const pdfUrl = URL.createObjectURL(blob);
                            window.open(pdfUrl, '_blank');
                            output.textContent = 'PDF generado y abierto.';
                            return;
                        }

                       
                        const text = await response.text();
                        try {
                            output.textContent = text ? JSON.stringify(JSON.parse(text), null, 2) : 'Sin contenido';
                        } catch {
                            output.textContent = text || 'Sin contenido';
                        }

                    } catch (e) {
                        output.textContent = 'Fallo de red: ' + e.message;
                    }
                });
            });

            function buildBody(form) {
                const data = {};
                form.querySelectorAll('input[name], select[name], textarea[name]').forEach(input => {
                    if (input.dataset.path || input.dataset.query) return;
                    let value = input.value.trim();
                    if (!value) return;

                    if (input.dataset.type === 'number') value = Number(value);
                    setNestedValue(data, input.name, value);
                });
                return data;
            }

            function setNestedValue(target, path, value) {
                const keys = path.split('.');
                let curr = target;
                keys.forEach((k, i) => {
                    if (i === keys.length - 1) curr[k] = value;
                    else {
                        if (!curr[k]) curr[k] = {};
                        curr = curr[k];
                    }
                });
            }
        })();
    </script>
</body>
</html>
